Zepto(function(e){function t(e){window.localStorage.setItem("serverAddress",e),X=e,Y=X+"/mobile.asmx"}function r(t,r){X?(document.activeElement.blur(),e(document).blur(),e.ajax({type:"POST",url:Y+"/UserLogin",contentType:"application/json; charset=utf-8",async:!0,data:JSON.stringify({login:t,pass:r}),dataType:"json",success:function(e){console.log(e.d),W=JSON.parse(e.d),0!=W?(rt.changes=0,rt.logged=!0,rt.logTime=N(),rt.user=W,y("Login successful","short","top"),setTimeout(function(){ft.settings(),y("user.ID_Group = "+rt.user.ID_Group,"long","top")},10)):setTimeout(function(){gt.hide(),y("Incorrect Login details","short","top")},50)},error:function(e,t){setTimeout(function(){gt.hide(),y("Ajax error : "+t.toString(),"long","top")},50)}})):y("Please enter an IP address in the settings page","long","top")}function o(){return 1==R.Browser?window.TEMPORARY:LocalFileSystem.PERSISTENT}function n(e){if(1==R.Browser){var t=x(e),r=new Blob([t],{type:"text/plain"});return r}var r=x(e);return r}function a(t){ot=!0;var r=new Image;e("map>viewport").css({"-webkit-transform":"matrix(1,0,0,1,0,0)"}),e("map>viewport>img").attr({src:" ",width:"0",height:"0"}).css({"-webkit-transform":"matrix(1,0,0,1,0,0)"}),e("viewport>pog").remove(),r.src=t,r.onload=function(){var t,o,n=r.width,a=r.height,i=e("map").height()/a,t=i*n,o=i*a;t>e("map").width()&&(i=e("map").width()/t,t=i*t,o=i*o);var l=e("map").width()/2-t/2,c=e("map").height()/2-o/2;e("map>viewport>img").attr({src:r.src,width:t,height:o,offset:l+" "+c}).css({"-webkit-transform":"matrix(1,0,0,1,"+l+","+c+")"}),s(),setTimeout(function(){e("#MapsMasterPanel").removeAttr("open").attr("right",""),e("#DevicesOnMapPanel").removeAttr("left").attr("open",""),gt.hide()},10)}}function i(t,r){DeviceAdd=!0,At.empty(),Mt.empty();var o=e("map").position();t-=parseFloat(o.left),r-=parseFloat(o.top);var n=e("map>viewport>img").css("-webkit-transform");n=n.substr(n.lastIndexOf("(")).replace(/\(|\)/g,"").split(", ");var a=n[5],i=n[4];t-=i,r-=a,t=parseFloat(t)/parseFloat(e("map>viewport>img").width())*B,r=parseFloat(r)/parseFloat(e("map>viewport>img").height())*q;for(var l,c=0;c<z.length;c++)if(z[c].ID_Device==e("#ulFloat").attr("value")){l=z[c].ID_Device,z[c].X=t,z[c].Y=r,z[c].ID_Map=nt.ID_Map,z[c].Image="devimg/default.png";var p=it.ID_Group+",";p+=nt.ID_Map+",",p+=parseInt(t)+","+parseInt(r)+",",p+=!1+"",S(z[c].ID_Device,p.toString())}e("#MissingDevicesPanel").removeAttr("open").attr("right",""),e("#InformationPanel").removeAttr("left").attr("open",""),setTimeout(function(){s(),at=k(l),e.each(e("map>viewport>pog"),function(t,r){e(r).attr("id")==at.ID_Device&&e(r).addClass("selecteddevice")}),I()},10)}function s(){c(),e("viewport>pog").remove();var t="",r=e("map>viewport>img").css("-webkit-transform");r=r.substr(r.lastIndexOf("(")).replace(/\(|\)/g,"").split(", ");for(var o=r[5],n=r[4],a=0;a<z.length;a++)if(z[a].ID_Map==nt.ID_Map){var i=parseFloat(z[a].X)/B*parseFloat(e("map>viewport>img").width()),s=parseFloat(z[a].Y)/q*parseFloat(e("map>viewport>img").height()),l="";l=100>s?"1,0,0,-1":100>i?"0,-1,-1,0":i>B-100?"0,-1,1,0":"1,0,0,1";var p="-webkit-transform: matrix("+l+","+i+","+s+"); top:"+o+"; left:"+n+";",u=1==z[a].Locked?"locked":"unlocked";console.log(u),t+="<pog style='"+p+"' class='"+u+"'id='"+z[a].ID_Device+"'></pog>"}e("map>viewport").append(t)}function l(){if(1==ot){c(),e("map>viewport").css({"-webkit-transform":"matrix(1,0,0,1,0,0)"}),e("map>viewport>img").css({"-webkit-transform":"matrix(1,0,0,1,0,0)"});var t,r,o=e("map>viewport>img").width(),n=e("map>viewport>img").height();console.log(o+" "+n);var a=e("map").height()/n;r=a*n,t=a*o,t>e("map").width()&&(a=e("map").width()/t,r=a*r,t=a*t),console.log(r+" "+t);var i=e("map").width()/2-t/2,l=e("map").height()/2-r/2;i=Math.round(i),l=Math.round(l),e("map>viewport>img").attr({width:t,height:r,offset:i+" "+l}).css({"-webkit-transform":"matrix(1,0,0,1,"+i+","+l+")"}),s()}}function c(){e("viewport>pog").remove()}function p(){ot=!1,e("map>viewport").css({"-webkit-transform":"matrix(1,0,0,1,0,0)"}),e("map>viewport>img").attr({src:"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",width:"0",height:"0"}).css({"-webkit-transform":"matrix(1,0,0,1,0,0)"})}function u(t){var r=N(),o="";o+='<dropdown class="master expand"><dropdown class="head"><p>'+r+'</p><a href="#" class="button"></a></dropdown><dropdown class="content">';for(var n=0;n<t.length;n++){null==t[n].ID&&(t[n].ID="Unknown Device"),o+='<dropdown class="master expand"><dropdown class="head"><p>'+t[n].ID+'</p><a href="#" class="button"></a></dropdown><dropdown class="content">';for(var a=0;a<t[n].Tasks.length;a++)console.log(""),o+='<row class="item"><p>'+t[n].Tasks[a].Type+"</p><p>"+t[n].Tasks[a].Value+"</p></row>";o+="</dropdown></dropdown>"}o+="</dropdown></dropdown>",e("#logbookLog").prepend(o)}function d(e){for(var t=e.slice(0),r=new Array,o=new Array;t.length>0;)r.push(t[0]),r.length==J&&(o.push(r),r=new Array),t.splice(0,1);return 0!=r.length&&(o.push(r),r=new Array),o}function g(){if(e("#infoMapNum").val("Number of Maps : "+H.length),console.log("Number of Maps : "+H.length),H.length>0){var t=H.slice(0);t=d(t);var r="";r+="<panel class='group'>";for(var o=0;o<t.length;o++){r+="<panel right class='child'><scroll class='y'><row class='content'>";for(var n=0;n<t[o].length;n++){var a=t[o][n].Name,i=t[o][n].Description,s=t[o][n].ID_Map;(0==a.length||null==a)&&(a="Name unavalible"),0==i.length&&(i="No description"),r+="<row class='button item map' id='"+s+"'><span><name>"+a+"</name><serial>"+i+"</serial></span></row>"}r+="</row></scroll></panel>"}r+="</panel>",t.length>1&&(r+='<row class="master" style="-webkit-box-flex: 1; min-height: 40px;max-height: 40px;"><row class="back"><a href="#" class="button backward" id="btnBackwards"></a><indicator>1</indicator><a href="#" class="button forward" id="btnforwards"></a></row></row>'),e("#MapsMasterGroup").empty().append(r),e("#MapsMasterGroup>panel.group").children().hide(),setTimeout(function(){e("#MapsMasterGroup>panel.group>panel:first-child").attr("open","").removeAttr("left").removeAttr("right").show()},1),r.length=0}else{var r="";r+="<row class='item none' id='none'><span><name>No Maps</name><serial>This group contains no maps</serial></span></row>",console.log("Drawing"),e("#MapsMasterGroup").empty().append(r),r.length=0}}function h(){var t="";t+="<row class='item none' id='none'><span><name>Loading Devices</name><serial>This may take some time.</serial></span></row>",console.log("Drawing"),e("#DevicesonMapGroup").empty().append(t),t.length=0}function m(){var t="";t+="<row class='item none' id='none'><span><name>Loading Devices..</name><serial>This may take some time.</serial></span></row>",e("#MissingDevicesGroups").empty().append(t),t.length=0}function v(){e("#infoDeviceNum").val("Number of Devices : "+z.length)}function f(){var t=rt.lastUpdate.replace(/\"/g," ");t.length>0?e("#infoDownloadDate").val(t):e("#infoDownloadDate").val("Unknown Date")}function w(){nt.Description?e("#MapTitle").empty().html(nt.Name):e("#MapTitle").empty().html("OneStop")}function D(){return E.online}function b(t,r){for(var o=0;o<z.length;o++)z[o].ID_Device==at.ID_Device&&("locked"==r&&(z[o].Locked=t,e.each(e("map>viewport>pog"),function(t,r){e(r).attr("id")==z[o].ID_Device&&e(r).toggleClass("unlocked").toggleClass("locked")}),T(at.ID_Device,"lock",t),at=z[o],tt=!0),"description"==r&&(z[o].Description=t,T(at.ID_Device,"description",t),e("#infoDeviceDescription").val(at.Description),at=z[o],I(),tt=!0),"location"==r&&(z[o].Location=t,T(at.ID_Device,"location",t),e("#infoDeviceLocation").val(at.Location),at=z[o],I(),tt=!0),"serialnumber"==r&&(z[o].SerialNumber=t,T(at.ID_Device,"serialnumber",t),e("#infoDeviceSerialNumber").val(at.SerialNumber),at=z[o],I(),tt=!0),"assetnumber"==r&&(z[o].AssetNumber=t,T(at.ID_Device,"assetnumber",t),e("#infoDeviceAssetNumber").val(at.AssetNumber),at=z[o],I(),tt=!0))}function y(e,t,r){0==R.Browser?window.plugins.toast.show(e,t,r,function(){},function(e){alert("Toast Error"+e)}):console.log(e)}function A(t){try{p(),c(),l(),nt.length=0,at=0,H.length=0,z.length=0,st.length=0,lt.length=0,At.empty(),Mt.empty(),K.length=0,e("li.button.remove").removeClass("remove"),e("#btnBinSelected").html(K.length+" selected"),e("#deleteoptions").attr("novis",""),e("#deleteoptions").prev().removeAttr("novis"),it=V[t],console.log("CurrentGroup = "),console.log(it),e("#inputselectGroup").val(it.ID_Group+" - "+it.Name),gt.show(),wt.data()}catch(r){alert("trying changeGroup with num "+t+" error: "+r.toString())}}function M(){e("#imageDevice").css("background-image","url(./img/icon.png)"),e("#infoDevicePosition").val(""),e("#infoDeviceDescription").val(""),e("#infoDeviceLocation").val(""),e("#infoDeviceSerialNumber").val(""),e("#infoDeviceAssetNumber").val(""),e("#infoDeviceLock").prop("checked",0)}function I(){ht.ClearImage(),e("#infoDevicePosition").val(at.X.toFixed(0)+" : "+at.Y.toFixed(0)),e("#infoDeviceDescription").val(at.Description),""==at.Location||null==at.Location?e("#infoDeviceLocation").val("No Location"):e("#infoDeviceLocation").val(at.Location),""==at.SerialNumber||null==at.SerialNumber?e("#infoDeviceSerialNumber").val("No Serial"):e("#infoDeviceSerialNumber").val(at.SerialNumber),""==at.AssetNumber||null==at.AssetNumber?e("#infoDeviceAssetNumber").val("No Asset Number"):e("#infoDeviceAssetNumber").val(at.AssetNumber),1==at.Locked?e("#infoDeviceLock").prop("checked",1):e("#infoDeviceLock").prop("checked",0)}function T(e,t,r){var o={Type:"save",Attribute:t,Value:r};if(Z.length>0){for(var n=!1,a=0;a<Z.length;a++)Z[a].ID==e&&(n=!0,Z[a].Tasks.push(o));0==n&&(console.log(e+"Add to End"),Z.push({ID:e,Tasks:[]}),Z[Z.length-1].Tasks.push(o))}else Z.push({ID:e,Tasks:[]}),Z[Z.length-1].Tasks.push(o)}function S(e,t){var r={Type:"insert",Value:t};if(Z.length>0){for(var o=!1,n=0;n<Z.length;n++)Z[n].ID==e&&(o=!0,Z[n].Tasks.push(r));0==o&&(Z.push({ID:e,Tasks:[]}),Z[Z.length-1].Tasks.push(r))}else Z.push({ID:e,Tasks:[]}),Z[Z.length-1].Tasks.push(r)}function F(e){var t={Type:"remove",Attribute:null,Value:null};if(Z.length>0){for(var r=!1,o=0;o<Z.length;o++)Z[o].ID==e&&(r=!0,Z[o].Tasks.push(t));0==r&&(Z.push({ID:e,Tasks:[]}),Z[Z.length-1].Tasks.push(t))}else Z.push({ID:e,Tasks:[]}),Z[Z.length-1].Tasks.push(t)}function k(e){for(var t=0;t<z.length;t++)if(z[t].ID_Device==e)return z[t]}function N(){var e=new Date;return e.toUTCString()}function x(e){return JSON.stringify(e)}function x(e){return JSON.stringify(e)}function G(e,t,r,o){navigator.notification.confirm(e,t,r,o)}function O(e,t,r,o,n){navigator.notification.prompt(e,t,r,o,n)}function _(){e("#btnTogPanel").trigger("tap"),P=!0,1==R.Browser||navigator.splashscreen.hide()}function C(){console.log("getting first group"),e("#GroupPanel>panel.group").empty();for(var t=V[0].ID_Group,r=0;r<V.length;r++)V[r].ID_Group==t&&(A(r),console.log("changeGroup called from GetFirstGroup"));yt.MoveForward()}try{var P=!1,R={IOS:!!e.os.ios,Android:!!e.os.android,Version:e.os.version,Browser:!1},E={status:"offline",type:"none",online:!1};R.Browser=!1,e.each(e("scroll.y"),function(t,r){e(r).css({width:"100%","max-width":e(r).width(),"min-width":e(r).width()})});var L={start:{},end:{},center:{},dist:{},oldScale:1,scale:1,matrix:null};R.IOS&&(e("#deviceStyle").attr("href","css/ios.css"),parseFloat(R.Version)>=7&&e("page").css({"padding-top":"20px"})),R.Android&&e("#deviceStyle").attr("href","css/ios.css"),R.Android||R.IOS||e("#deviceStyle").attr("href","css/android.css");var U,j=!0,B=1e3,q=750,J=30,X=window.localStorage.getItem("serverAddress"),Y=X+"/mobile.asmx";1==R.Browser?(window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,U=0):U=0,String.prototype.capitalize=function(){return this.replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()})};var W=new Object,V=new Array,z=new Array,H=new Array,Z=new Array,K=new Array,Q=!1,$=!1,et=!1,tt=!1,rt={logged:!1,logTime:"",user:new Object,lastUpdate:"",changes:0},ot=!1,nt=new Object,at=new Object,it=new Object,st=new Array,lt=new Array,ct={show:function(){""==e("shadow").attr("novis")&&e("shadow").removeAttr("novis")},hide:function(){e("shadow").attr("novis","")}},pt={show:function(){e("#login").removeAttr("novis")},hide:function(){e("#login").attr("novis","")}},ut={show:function(){e("#settings").removeAttr("novis")},hide:function(){e("#settings").attr("novis","")}},dt={show:function(){console.log("***showing main page!"),e("#main").removeAttr("novis")},hide:function(){e("#main").attr("novis","")}},gt={show:function(){R.Browser||window.plugins.spinnerDialog.show()},hide:function(){R.Browser||window.plugins.spinnerDialog.hide()}},ht={show:function(){e("#DeviceImageDisplay").removeAttr("novis")},hide:function(){e("#DeviceImageDisplay").attr("novis","")},loadImage:function(t){e("#DeviceImageDisplay>display.content").empty().append("<img/>");var r=e("#DeviceImageDisplay>display.content>img"),o=new Image;o.src=t,o.onload=function(){var e,t,n=o.width,a=o.height;if(a<r.parent().height()&&n<r.parent().width()){var i=Math.round(r.parent().width()/2-n/2),s=Math.round(r.parent().height()/2-a/2);console.log(i+" "+s),r.width(n),r.height(a),r.attr("src",o.src),r.css({"-webkit-transform":"matrix(1,0,0,1,1,"+s+")"})}else{var l=r.parent().height()/a,t=a*l,e=n*l;e>r.parent().width()&&(l=r.parent().width()/e,e=l*e,t=l*t);var i=Math.round(r.parent().width()/2-e/2),s=Math.round(r.parent().height()/2-t/2);console.log(i+" "+s),r.width(e),r.height(t),r.attr("src",o.src),r.css({"-webkit-transform":"matrix(1,0,0,1,1,"+s+")"})}}},ClearImage:function(){e("#DeviceImageDisplay>display.content").empty()},Resizemage:function(){if(null==e("#DeviceImageDisplay").attr("novis")){console.log("Resizing"),console.log(e("#DeviceImageDisplay").attr("novis"));var t,r,o=e("#DeviceImageDisplay>display.content>img"),n=o.width(),a=o.height();if(a<o.parent().height()&&n<o.parent().width()){Math.round(o.parent().width()/2-n/2);var i=Math.round(o.parent().height()/2-a/2);o.width(n),o.height(a),o.css({"-webkit-transform":"matrix(1,0,0,1,1,"+i+")"})}else{var s=o.parent().height()/a,r=a*s,t=n*s;t>o.parent().width()&&(s=o.parent().width()/t,t*=s,r*=s),Math.round(o.parent().width()/2-t/2);var i=Math.round(o.parent().height()/2-r/2);o.width(t),o.height(r),o.css({"-webkit-transform":"matrix(1,0,0,1,1,"+i+")"})}}}},mt={groups:function(){console.log("Using AJAX to get groups"),e.ajax({type:"POST",url:Y+"/GetAvalibleGroups",contentType:"application/json; charset=utf-8",async:!0,data:JSON.stringify({data:rt.user.ID_Group}),dataType:"json",success:function(e){V=JSON.parse(e.d),0!=V&&ft.groups()},error:function(){}})},maps:function(){e.ajax({type:"POST",url:Y+"/GetMaps",contentType:"application/json; charset=utf-8",async:!0,data:JSON.stringify({data:it.ID_Group}),dataType:"json",success:function(e){0==e.d?H.length=0:H=JSON.parse(e.d),mt.devices()},error:function(){}})},devices:function(){e.ajax({type:"POST",url:Y+"/GetDevices",contentType:"application/json; charset=utf-8",async:!0,data:JSON.stringify({data:it.ID_Group}),dataType:"json",success:function(e){0==e.d?z.length=0:z=JSON.parse(e.d),rt.lastUpdate=N(),ft.data(),y("Data downloaded","short","top")},error:function(){}})},changes:function(){Z[Z.length-1].Date&&Z.splice(Z.length-1,1),e.ajax({type:"POST",url:Y+"/Tasks",contentType:"application/json; charset=utf-8",async:!0,data:JSON.stringify({todo:Z}),success:function(e){Z.length=0,rt.changes=0;var t=JSON.parse(e.d);console.log(t),u(t),Dt.changes(),K.length=0,setTimeout(function(){ft.settings(),ft.data(),y("Upload finished - Check log","short","top"),setTimeout(function(){st.length=0,lt.length=0;for(var e=0;e<z.length;e++)z[e].ID_Map==nt.ID_Map&&st.push(z[e]),0==z[e].ID_Map&&lt.push(z[e]);st=d(st),lt=d(lt),At.empty(),Mt.empty(),h(),m(),setTimeout(function(){At.MoveForward()},100)},100),s()},100)},error:function(t,r){alert(r),e("#logbookLog").append("<p>"+r+"</p>"),gt.hide(),y("Upload failed","short","top")}})}},vt={getPicture:function(){try{navigator.camera.getPicture(vt.pictureSuccess,vt.pictureFail,{quality:50,destinationType:navigator.camera.DestinationType.FILE_URI,sourceType:navigator.camera.PictureSourceType.CAMERA,encodingType:navigator.camera.EncodingType.JPEG,saveToPhotoAlbum:!0})}catch(e){alert(e.toString())}},getCameraroll:function(){try{navigator.camera.getPicture(vt.pictureSuccess,vt.pictureFail,{quality:50,destinationType:navigator.camera.DestinationType.FILE_URI,sourceType:navigator.camera.PictureSourceType.PHOTOLIBRARY,encodingType:navigator.camera.EncodingType.JPEG})}catch(e){alert(e.toString())}},pictureSuccess:function(e){try{var t=e.substr(e.lastIndexOf("/")+1);setTimeout(function(){O("Give the image a name",function(r){if(1==r.buttonIndex){t=r.input1+".jpg";for(var o=0;o<z.length;o++)z[o].ID_Device==at.ID_Device&&(z[o].Image="devimg/"+t,at=z[o]);T(at.ID_Device,"image","devimg/"+t),ft.data(),vt.copyImageToDir(e,t)}},"Device Image",["Done","Cancel"],at.Description)},10)}catch(r){alert(x(r))}},pictureFail:function(){alert("Camera Fail: "+Ct.toString())},copyImageToDir:function(e,t){var r="";setTimeout(function(){window.requestFileSystem(o(),U,function(o){o.root.getDirectory("OSMobile/devimg",{create:!0},function(o){r=o.toURL(),window.resolveLocalFileSystemURI(e,function(o){window.resolveLocalFileSystemURI(r,function(r){o.copyTo(r,t,function(){if(1==D())try{var r=Y+"/SaveImage",o=new FileUploadOptions;o.fileKey="file",o.fileName=t,o.mimeType="image/jpeg";var n=new FileTransfer;n.upload(e,r,function(){y("Image uploaded","short","top"),I(),ht.hide(),setTimeout(function(){ht.show(),wt.devImg()},10)},function(e){alert("Upload Transfer error: "+x(e))},o)}catch(a){alert("Upload error: "+a.toString())}else y("Unable to uplaod device image","long","top")},function(e){switch(e.code){case 12:alert("Copy Failure: Device image with that name already exists");break;default:alert(e.code)}})},bt.error)},bt.error)},bt.error)},bt.error)},100)}},ft={settings:function(){var e="settings.json",t=rt;window.requestFileSystem(o(),U,function(r){r.root.getDirectory("OSMobile",{create:!0},function(r){r.getFile(e,{create:!0},function(r){r.createWriter(function(r){r.onwritestart=function(){console.log("Writing File: "+e)},r.onwriteend=function(){console.log("Write complete: "+e),0==V.length&&mt.groups()},r.write(n(t))},bt.error)},bt.error)},bt.error)},bt.error)},groups:function(){var e="groups.json",t=V;window.requestFileSystem(o(),U,function(r){r.root.getDirectory("OSMobile/data",{create:!0},function(r){r.getFile(e,{create:!0},function(r){r.createWriter(function(r){r.onwritestart=function(){console.log("Writing File: "+e)},r.onwriteend=function(){console.log("**Write complete"),console.log("Write complete: "+e),C(),setTimeout(function(){pt.hide(),ut.hide(),dt.show(),gt.hide()},50)},r.write(n(t))},bt.error)},bt.error)},bt.error)},bt.error)},data:function(){var e=it.ID_Group+".json",t=new Object;t.Date=N(),t.Maps=H,t.Devices=z,window.requestFileSystem(o(),U,function(r){r.root.getDirectory("OSMobile/data",{create:!0},function(r){r.getFile(e,{create:!0},function(r){r.createWriter(function(r){r.onwritestart=function(){console.log("Writing File: "+e)},r.onwriteend=function(){console.log("Write complete: "+e),g(),console.log("DrawAvalibleMaps - writefile.data"),v(),f(),gt.hide()},r.write(n(t))},bt.error)},bt.error)},bt.error)},bt.error)},changes:function(){var e,t="changes.json";Z.splice(Z.length,1),Z.push({Date:N()}),e=Z,window.requestFileSystem(o(),U,function(r){r.root.getDirectory("OSMobile",{create:!0},function(r){r.getFile(t,{create:!0},function(r){r.createWriter(function(r){r.onwritestart=function(){console.log("Writing File: "+t)},r.onwriteend=function(){Z.length=0},r.write(n(e))},bt.error)},bt.error)},bt.error)},bt.error)}},wt={settings:function(){var t="settings.json";window.requestFileSystem(o(),U,function(r){r.root.getDirectory("OSMobile",{create:!0},function(r){r.getFile(t,{create:!1},function(t){t.file(function(t){var r=new FileReader;r.onload=function(){if(this.result.length>0){console.log("JSON PARSE THIS! "+JSON.parse(this.result));var t=JSON.parse(this.result);rt=t,1==rt.logged?(console.log("setings = "),console.log(rt),e("#inputPrevUsername").val(rt.user.Name),e("#inputLogTime").val(rt.logTime)):console.log("Not logged in"),0==P&&_()}else e("#inputPrevUsername").val("No previous user"),e("#inputLogTime").val("  "),0==P&&_()},r.readAsText(t)},bt.error)},function(t){1==t.code?(console.log("Settings file not found."),e("#inputPrevUsername").val("No previous user"),e("#inputLogTime").val("  "),0==P&&_()):bt.error(t)})},bt.error)},bt.error)},groups:function(){var t="groups.json";window.requestFileSystem(o(),U,function(r){r.root.getDirectory("OSMobile/data",{create:!0},function(r){r.getFile(t,{create:!1},function(t){t.file(function(t){var r=new FileReader;r.onload=function(){if(console.log("Reading Groups File"),this.result.length>0){console.log(this.result);var t=JSON.parse(this.result);V.length=0;for(var r=0;r<t.length;r++)V.push(t[r]);C(),setTimeout(function(){pt.hide(),ut.hide(),dt.show(),gt.hide(),e("#btnTogPanel").trigger("tap")},50)}else console.log("No Groups")},r.readAsText(t)},bt.error)},function(e){1==e.code?(1==D()?mt.groups():gt.hide(),y("Connection offline, Unable to download groups","long","bottom")):bt.error(e)})},bt.error)},bt.error)},data:function(){console.log("reading data file");var e=it.ID_Group+".json";window.requestFileSystem(o(),U,function(t){t.root.getDirectory("OSMobile/data",{create:!0},function(t){t.getFile(e,{create:!1},function(e){e.file(function(e){var t=new FileReader;t.onload=function(){if(y("Reading data from this device","short","top"),this.result.length>0){var e=JSON.parse(this.result);rt.lastUpdate=x(e.Date),H.length=0,z.length=0;for(var t=0;t<e.Maps.length;t++)H.push(e.Maps[t]);for(var t=0;t<e.Devices.length;t++)z.push(e.Devices[t]);g(),console.log("DrawAvalibleMaps - readfile.data"),v(),At.empty(),Mt.empty(),f(),setTimeout(function(){gt.hide()},250)}},t.readAsText(e)},bt.error)},function(e){1==e.code?1==D()?mt.maps():(gt.hide(),g(),console.log("DrawAvalibleMaps - readfile.data - else"),v(),At.empty(),At.MoveForward(),y("Connection offline, Unable to download data","long","bottom")):bt.error(e)})},bt.error)},bt.error)},changes:function(e){var t="changes.json";try{window.requestFileSystem(o(),U,function(e){e.root.getDirectory("OSMobile",{create:!0},function(e){e.getFile(t,{create:!1},function(e){e.file(function(e){var t=new FileReader;t.onload=function(){if(this.result.length>0){var e=JSON.parse(this.result);alert(e.length),Z=e}else alert("No Changes")},t.readAsText(e)},bt.error)},function(e){1==e.code?(gt.hide(),console.log("No chanegs file found")):bt.error(e)})},bt.error)},bt.error)}catch(e){alert(e.toString())}},maps:function(){var e=nt.Path.substr(nt.Path.lastIndexOf("/")+1),t="";window.requestFileSystem(o(),U,function(r){r.root.getDirectory("OSMobile/maps",{create:!0},function(r){t=r.toURL(),r.getFile(e,{create:!1},function(e){var t=e.toURL();console.log("fileURL = "+t),a(t)},function(r){1==r.code?1==D()?(It.map(e,t),console.log("download.map called from ReadFile.maps")):(wt.forceMissingMap(),console.log("ReadFile.forceMissingMap called from ReadFile.maps"),gt.hide(),y("Connection offline, Unable to download map","long","bottom")):bt.error(r)})},bt.error)},bt.error)},forceMissingMap:function(){a("missing.jpg"),gt.hide()},devImg:function(){var e=at.Image.substr(at.Image.lastIndexOf("/")+1),t="";window.requestFileSystem(o(),U,function(r){r.root.getDirectory("OSMobile/devimg",{create:!0},function(r){t=r.toURL(),r.getFile(e,{create:!1},function(e){var t=e.toURL();ht.loadImage(t)},function(r){1==r.code?1==D()?It.devimg(e,t):(gt.hide(),alert("Unable to download device image. Please check your connection")):bt.error(r)})},bt.error)},bt.error)}},Dt={settings:function(){var e="settings.json";window.requestFileSystem(o(),U,function(t){t.root.getDirectory("OSMobile",{create:!0},function(t){t.getFile(e,{create:!1},function(e){e.remove(null,null)},null)},bt.error)},bt.error)},groups:function(){var e="groups.json";try{window.requestFileSystem(o(),U,function(t){t.root.getDirectory("OSMobile/data",{create:!0},function(t){t.getFile(e,{create:!1},function(e){e.remove(null,null)},null)},bt.error)},bt.error)}catch(t){y("error removing groups file : "+t,"long","top")}},data:function(){window.requestFileSystem(o(),U,function(e){e.root.getDirectory("OSMobile/data",{create:!0},function(e){var t=e.createReader();t.readEntries(function(e){for(var t=0;t<e.length;t++)e[t].remove()},null)},bt.error)},bt.error)},changes:function(){var e="changes.json";window.requestFileSystem(o(),U,function(t){t.root.getDirectory("OSMobile",{create:!0},function(t){t.getFile(e,{create:!1},function(e){e.remove(null,null)},null)},bt.error)},bt.error)}},bt={error:function(e){var t="";switch(e.code){case FileError.ENCODING_ERR:t="The url is malformed.";break;case FileError.INVALID_MODIFICATION_ERR:t="The modification requested is not allowed. For example, the app might be trying to move a directory into its own child or moving a file into its parent directory without changing its name";break;case FileError.INVALID_STATE_ERR:t="The operation cannot be performed on the current state of the interface object.";break;case FileError.NO_MODIFICATION_ALLOWED_ERR:t="The state of the underlying file system prevents any writing to a file or a directory.";break;case FileError.NOT_FOUND_ERR:t="A required file or directory could not be found.";break;case FileError.NOT_READABLE_ERR:t="The file or directory cannot be read, typically due to permission problems that occur after a reference to a file has been acquired.";break;case FileError.PATH_EXISTS_ERR:t="The file or directory with the same path already exists.";break;case FileError.QUOTA_EXCEEDED_ERR:t="Either there's not enough remaining storage space or the storage quota was reached or the user declined to give more space to the database.";break;case FileError.SECURITY_ERR:t="SECURITY_ERR ";break;case FileError.TYPE_MISMATCH_ERR:t="The app looked up an entry,but the entry found is of the wrong type.For example, the app is asking for a directory, when the entry is really a file.";break;default:t="Unknown Error "}alert(t+" "+e.code),console.log(t+" "+e.code)}},yt={MoveForward:function(t){if(0==e("#GroupsMasterGroup").children().length)console.log("Create Root"),yt.RootGroup();else{var r=!1,o=null;e.each(e("#GroupsMasterGroup>panel.group").children(),function(n,a){e(a).attr("child")==t&&(r=!0,o=e(a))}),0==r?(console.log("Create SubGroup"),yt.CreateSubGroup(t)):setTimeout(function(){e("#GroupsMasterGroup>panel.group").children("[open]").removeAttr("open").attr("left",""),o.removeAttr("right").attr("open",""),e("#GroupsMasterGroup").parent().next().removeAttr("novis"),gt.hide()},10)}},RootGroup:function(){e("#GroupsMasterGroup").empty();var t="";t+="<panel class='group'>";var r=V[0],o="hasKids";0==yt.CheckForChildren(r)&&(o+=" hide"),t+="<panel open class='child' root><scroll class='y'><row class='content'>",t+="<row class='item' groupid='"+r.ID_Group+"' fullpath='"+r.FullPath+"' groupPath='"+r.GroupPath+"'' ><span><name>"+r.ID_Group+" - "+r.Name+"</name></span><a class='button "+o+" ' href='#'></a><a class='button isselected' href='#'></a></row>",t+="</row></scroll></panel></panel>",e("#GroupsMasterGroup").append(t),e("#GroupsMasterGroup").parent().next().attr("novis",""),gt.hide()},CreateSubGroup:function(t){var r=e("#GroupsMasterGroup>panel.group"),o="";o+="<panel right class='child' child='"+t+"' ><scroll class='y'><row class='content'>";for(var n=new Array,a=V.slice(0),i=1;i<a.length;i++)a[i].FullPath==t+""+a[i].ID_Group+"."&&n.push(a[i]);for(var i=0;i<n.length;i++){var s="haskids";0==yt.CheckForChildren(n[i])&&(s+=" hide"),o+="<row class='item' groupid='"+n[i].ID_Group+"' fullpath='"+n[i].FullPath+"' groupPath='"+n[i].GroupPath+"'' ><span><name>"+n[i].ID_Group+" - "+n[i].Name+"</name></span><a class='button "+s+" ' href='#'></a><a class='button isselected' href='#'></a></row>"}o+="</row></scroll></panel>",e(r).append(o),setTimeout(function(){e(r).children("[open]").removeAttr("open").attr("left",""),e(r).children(":last-child").removeAttr("right").attr("open",""),e("#GroupsMasterGroup").parent().next().removeAttr("novis"),gt.hide()},10)},CheckForChildren:function(e){for(var t=0,r=V.slice(0),o=0;o<r.length;o++)r[o].GroupPath==e.GroupPath+"."+e.ID_Group&&t++;return t}},At={current:0,RootGroup:function(){e("#DevicesonMapGroup").empty();var t="";t+="<panel class='group'>",t+="<panel open class='child '><scroll class='y'><row class='content'>";for(var r=0;r<st[0].length;r++){var o=st[0][r].ID_Device,n=st[0][r].Description,a=st[0][r].SerialNumber;0==n.length&&(n="No Description"),0==a.length&&(a="No Serial Number"),t+="<row class='button item mDevice' id='"+o+"'><span><name>"+n+"</name><serial>"+a+"</serial></span></row>"}t+="</row></scroll></panel>",t+="</panel>",t+='<row class="master" style="-webkit-box-flex: 1; min-height: 40px;max-height: 40px;"><row class="back"><a href="#" class="button backward" id="btnBackwards_On"></a><indicator>0</indicator><a href="#" class="button forward" id="btnforwards_On"></a></row></row>',e("#DevicesonMapGroup").empty().append(t),t.length=0,At.current=0,gt.hide()},NextGroup:function(){var t="";t+="<panel right class='child '><scroll class='y'><row class='content'>",console.log(At.current);for(var r=0;r<At[At.current].length;r++){var o=At[At.current][r].ID_Device,n=At[At.current][r].Description,a=At[At.current][r].SerialNumber;0==n.length&&(n="No Description"),0==a.length&&(a="No Serial Number"),t+="<row class='button item mDevice' id='"+o+"'><span><name>"+n+"</name><serial>"+a+"</serial></span></row>"}t+="</row></scroll></panel>",e("#DevicesonMapGroup>panel.group").append(t),e("#DevicesonMapGroup>panel.group>panel.child").attr("left","").removeAttr("open").removeAttr("right"),e("#DevicesonMapGroup>panel.group>panel.child:last-child").attr("open","").removeAttr("left").removeAttr("right"),setTimeout(function(){e("#DevicesonMapGroup>panel.group>panel.child:first-child").remove()},700),t.length=0,gt.hide()},PrevGroup:function(){var t="";t+="<panel left class='child '><scroll class='y'><row class='content'>",console.log(At.current);for(var r=0;r<At[At.current].length;r++){var o=At[At.current][r].ID_Device,n=At[At.current][r].Description,a=At[At.current][r].SerialNumber;0==n.length&&(n="No Description"),0==a.length&&(a="No Serial Number"),t+="<row class='button item mDevice' id='"+o+"'><span><name>"+n+"</name><serial>"+a+"</serial></span></row>"}t+="</row></scroll></panel>",e("#DevicesonMapGroup>panel.group").append(t),e("#DevicesonMapGroup>panel.group>panel.child").attr("right","").removeAttr("open").removeAttr("left"),e("#DevicesonMapGroup>panel.group>panel.child:last-child").attr("open","").removeAttr("left").removeAttr("right"),setTimeout(function(){e("#DevicesonMapGroup>panel.group>panel.child:first-child").remove()},700),t.length=0,gt.hide()},empty:function(){At.current=-1;var t="";t+="<row class='item none' id='none'><span><name>No Devices</name><serial>This map has no devices</serial></span></row>",console.log("Drawing"),e("#DevicesonMapGroup").empty().append(t),t.length=0,gt.hide()},MoveForward:function(){st.length>0?-1==At.current?(gt.hide(),gt.show(),At.RootGroup()):(At.current++,At.current<st.length?(gt.hide(),gt.show(),At.NextGroup(),e("a.button#btnforwards_On").prev("indicator").html(Mt.current)):At.current--):At.empty()},MoveBackward:function(){At.curernt--,At.current<0?At.current=0:(gt.hide(),gt.show(),At.PrevGroup(),e("a.button#btnforwards_On").prev("indicator").html(Mt.current))}},Mt={current:0,RootGroup:function(){var t="";t+="<panel class='group'>",t+="<panel open class='child '><scroll class='y'><row class='content'>";for(var r=0;r<lt[0].length;r++){var o=lt[0][r].ID_Device,n=lt[0][r].Description,a=lt[0][r].SerialNumber;0==n.length&&(n="No Description"),0==a.length&&(a="No Serial Number"),t+="<row class='button item uDevice' id='"+o+"'><span><name>"+n+"</name><serial>"+a+"</serial></span></row>"}t+="</row></scroll></panel>",t+="</panel>",t+='<row class="master" style="-webkit-box-flex: 1; min-height: 40px;max-height: 40px;"><row class="back"><a href="#" class="button backward" id="btnBackwards_Off"></a><indicator>0</indicator><a href="#" class="button forward" id="btnforwards_Off"></a></row></row>',e("#MissingDevicesGroups").empty().append(t),t.length=0,Mt.current=0,gt.hide()
},NextGroup:function(){var t="";t+="<panel right class='child '><scroll class='y'><row class='content'>",console.log(Mt.current);for(var r=0;r<lt[Mt.current].length;r++){var o=lt[Mt.current][r].ID_Device,n=lt[Mt.current][r].Description,a=lt[Mt.current][r].SerialNumber;0==n.length&&(n="No Description"),0==a.length&&(a="No Serial Number"),t+="<row class='button item uDevice' id='"+o+"'><span><name>"+n+"</name><serial>"+a+"</serial></span></row>"}t+="</row></scroll></panel>",e("#MissingDevicesGroups>panel.group").append(t),e("#MissingDevicesGroups>panel.group>panel.child").attr("left","").removeAttr("open").removeAttr("right"),e("#MissingDevicesGroups>panel.group>panel.child:last-child").attr("open","").removeAttr("left").removeAttr("right"),setTimeout(function(){e("#MissingDevicesGroups>panel.group>panel.child:first-child").remove()},700),t.length=0,gt.hide()},PrevGroup:function(){var t="";t+="<panel left class='child '><scroll class='y'><row class='content'>",console.log(Mt.current);for(var r=0;r<lt[Mt.current].length;r++){var o=lt[Mt.current][r].ID_Device,n=lt[Mt.current][r].Description,a=lt[Mt.current][r].SerialNumber;0==n.length&&(n="No Description"),0==a.length&&(a="No Serial Number"),t+="<row class='button item uDevice' id='"+o+"'><span><name>"+n+"</name><serial>"+a+"</serial></span></row>"}t+="</row></scroll></panel>",e("#MissingDevicesGroups>panel.group").append(t),e("#MissingDevicesGroups>panel.group>panel.child").attr("right","").removeAttr("open").removeAttr("left"),e("#MissingDevicesGroups>panel.group>panel.child:last-child").attr("open","").removeAttr("left").removeAttr("right"),setTimeout(function(){e("#MissingDevicesGroups>panel.group>panel.child:first-child").remove()},700),t.length=0,gt.hide()},empty:function(){Mt.current=-1;var t="";t+="<row class='item none' id='none'><span><name>No Devices</name><serial>This map has no devices</serial></span></row>",e("#MissingDevicesGroups").empty().append(t),t.length=0,gt.hide()},MoveForward:function(){lt.length>0?-1==Mt.current?(gt.hide(),gt.show(),Mt.RootGroup()):(Mt.current++,Mt.current<lt.length?(gt.hide(),gt.show(),Mt.NextGroup(),e("a.button#btnforwards_Off").prev("indicator").html(Mt.current)):Mt.current--):Mt.empty()},MoveBackward:function(){Mt.current--,Mt.current<0?Mt.current=0:(gt.hide(),gt.show(),Mt.PrevGroup(),e("a.button#btnforwards_Off").prev("indicator").html(Mt.current))}},It={map:function(e,t){console.log("map function entered");var r=new FileTransfer,o=encodeURI(X+"/Maps/"+e),n=t+"/"+e;r.download(o,n,function(e){console.log("entry = "),console.log(e),wt.maps(),console.log("ReadFile.maps first call"),gt.hide()},function(e){switch(e.code){case FileTransferError.FILE_NOT_FOUND_ERR:y("Cannot find Map Image","long","bottom"),setTimeout(function(){wt.forceMissingMap()},1);break;case FileTransferError.INVALID_URL_ERR:alert("Server URL is incorrect.");break;case FileTransferError.CONNECTION_ERR:y("Cannot find connection path for Map Image","long","bottom"),setTimeout(function(){wt.forceMissingMap()},1);break;case FileTransferError.ABORT_ERR:msg+="Process was aborted.",gt.hide()}},!0,{headers:{Authorization:"Basic dGVzdHVzZXJuYW1lOnRlc3RwYXNzd29yZA=="}})},devimg:function(e,t){var r=new FileTransfer,o=encodeURI(X+"/devimg/"+e),n=t+"/"+e;r.download(o,n,function(e){var t=e.toURL();ht.loadImage(t)},It.error,!0,{headers:{Authorization:"Basic dGVzdHVzZXJuYW1lOnRlc3RwYXNzd29yZA=="}})},error:function(e){var t="";switch(e.code){case FileTransferError.FILE_NOT_FOUND_ERR:t+="File cannot be found.";break;case FileTransferError.INVALID_URL_ERR:t+="Server URL is incorrect.";break;case FileTransferError.CONNECTION_ERR:t+="Cannot find connection path for Image download";break;case FileTransferError.ABORT_ERR:t+="Process was aborted."}alert(t),gt.hide()}},Tt={ready:function(){0==R.Browser&&navigator.splashscreen.show(),E.online=!0,E.status="online",ct.hide(),M(),g(),console.log("DrawAvalibleMaps - PhoneGap.ready"),v(),At.empty(),Mt.empty(),f(),w(),E.type=1==R.Browser?"WiFi":navigator.connection.type,e("#deleteoptions").attr("novis",""),e("#deleteoptions").prev().removeAttr("novis"),j&&(e("#inputUsername").val("admin"),e("#inputPassword").val("admin")),wt.settings()},back:function(){e("#login").hasClass("visible")?navigator.app.exitApp():G("Do you want exit the app?",function(e){1==e&&navigator.app.exitApp()},"Exit App",["Exit","Cancel"])},pause:function(){navigator.splashscreen.hide()},resume:function(){navigator.splashscreen.hide()},online:function(){E.online=!0,E.status="online",E.type=navigator.connection.type,y("Device online","short","bottom"),e("#NetStatus").addClass("online").removeClass("offline"),1==rt.logged&&1==rt.changes&&G("Changes have been detected",function(t){1==t&&(wt.changes(),gt.show(),setTimeout(function(){mt.changes()},250)),2==t&&(Z.length=0,Dt.changes(),e("#btnDownload").trigger("tap"))},"Changes detected",["Upload","Ignore"])},offline:function(){E.online=!1,E.status="offline",E.type=navigator.connection.type,y("Device offline","short","bottom")}};document.addEventListener("deviceready",Tt.ready,!1),document.addEventListener("backbutton",Tt.back,!1),document.addEventListener("pause",Tt.pause,!1),document.addEventListener("resume",Tt.resume,!1),document.addEventListener("online",Tt.online,!1),document.addEventListener("offline",Tt.offline,!1);var St={preventMouse:!0,transformMinScale:1.1};e("#btnLogbook").hammer(St).on("tap",function(){console.log("hizsdbgfhsdfhidbh"),ct.show(),e("#logbook").removeAttr("novis")}),e("#btnTogPanel").hammer(St).on("tap",function(t){t.preventDefault(),0==et&&(et=!0,e(this).parents("page").find("content>panel.master").toggleClass("out").toggleClass("in"),e("map>viewport").attr("novis",""),c(),setTimeout(function(){e("map>viewport").removeAttr("novis"),l()},100),setTimeout(function(){et=!1},1e3))}),e("#btnLogin").hammer(St).on("tap",function(){if(""==e("#inputUsername").val()||""==e("#inputPassword").val())y("Username or password is blank","long","top");else if(gt.show(),1==D()){var t=e("#inputUsername").val(),o=e("#inputPassword").val();setTimeout(function(){r(t,o)},125)}else gt.hide(),console.log("server address = "+X),y("Connection is offline","long","top")}),e("#btnSettings").hammer(St).on("tap",function(){ut.show(),dt.hide(),pt.hide(),e("#inputServerAddress").val(X)}),e("#btnViewLogin").hammer(St).on("tap",function(){ut.hide(),pt.show()}),e("#btnSaveServerAddress").hammer(St).on("tap",function(){""==e("#inputServerAddress").val()?y("Server Address is blank","long","top"):(t(e("#inputServerAddress").val()),y("server ip set to = "+X,"long","top"))}),e("#btnClearData").hammer(St).on("tap",function(){try{localStorage.clear(),Dt.groups(),y("Local Storage Cleared","long","top")}catch(e){y("Error Clearing Local Storage : "+e,"long","top")}}),e("#btnDeviceComments").hammer(St).on("tap",function(){alert("Open the comments box")}),e("#btnContinue").hammer(St).on("tap",function(){1==rt.logged?(y("Loading Groups","short","top"),gt.show(),1==D()?(pt.hide(),ut.hide(),mt.groups()):(pt.hide(),wt.groups())):y("No previous user","short","center")}),e("#btnDownload").hammer(St).on("tap",function(){e("#MapTitle").empty().html("OneStop"),1==D()?(e("#MapsMasterPanel").removeAttr("left").removeAttr("right").attr("open",""),e("#DevicesOnMapPanel").removeAttr("open").removeAttr("left").removeAttr("right").attr("left",""),e("#MissingDevicesPanel").removeAttr("open").removeAttr("left").removeAttr("right").attr("right",""),e("#InformationPanel").removeAttr("open").removeAttr("left").removeAttr("right").attr("left",""),e("map>viewport>pog.selecteddevice").removeClass("selecteddevice"),e("#MapsMasterPanel").removeAttr("right").attr("open",""),p(),c(),gt.show(),nt=0,at=0,H.length=0,z.length=0,Z.length=0,K.length=0,e("li.button.remove").removeClass("remove"),e("#deleteoptions").attr("novis",""),e("#deleteoptions").prev().removeAttr("novis"),mt.maps()):(gt.hide(),y("Device offline. Unable to download data","long","center"))}),e("#btnBin").hammer(St).on("tap",function(){if(K.length>0){y("Deleting devices - Remeber to save","short","top"),gt.show();for(var t=0;t<K.length;t++){for(var r=0;r<z.length;r++)z[r].ID_Device==K[t]&&(z[r].ID_Map=0,z[r].Image="devimg/default.png",z[r].Locked=!1,z[r].X=0,z[r].Y=0);F(K[t])}ft.data(),st.length=0,lt.length=0;for(var t=0;t<z.length;t++)z[t].ID_Map==nt.ID_Map&&st.push(z[t]),0==z[t].ID_Map&&lt.push(z[t]);st=d(st),lt=d(lt),At.empty(),Mt.empty(),h(),m(),setTimeout(function(){At.MoveForward()},100),s(),e("#deleteoptions").attr("novis",""),e("#deleteoptions").prev().removeAttr("novis"),e("#btnBinSelected").html(" 0 "),K.length=0}else y("Nothing to delete","short","top")}),e("map>viewport>img").hammer(St).on("touch",function(){e("map>viewport>.selecteddevice").removeClass("selecteddevice")}),e("#btnSave").hammer(St).on("tap",function(){if(Z.length>0)if(1==D())gt.show(),setTimeout(function(){mt.changes()},100);else{gt.show();for(var e=new Array,t=0;t<Z.length;t++)e.push(Z[t]);Z.length=0;var r="changes.json";try{window.requestFileSystem(o(),U,function(t){t.root.getDirectory("OSMobile",{create:!0},function(t){t.getFile(r,{create:!1},function(t){t.file(function(t){var r=new FileReader;r.onload=function(){if(this.result.length>0){var t=JSON.parse(this.result);Z=t,Z.splice(Z.length-1,1);for(var r=0;r<e.length;r++)Z.push(e[r]);rt.changes=1,ft.settings(),ft.changes(),ft.data(),setTimeout(function(){gt.hide(),y("Changes saved local","short","top")},100)}else alert("No Changes")},r.readAsText(t)},bt.error)},function(t){if(1==t.code){for(var r=0;r<e.length;r++)Z.push(e[r]);rt.changes=1,ft.settings(),ft.changes(),ft.data(),setTimeout(function(){gt.hide(),y("Changes saved local","short","top")},100)}else bt.error(t)})},bt.error)},bt.error)}catch(n){alert(n.toString())}}else y("0 changes have been made","short","top")});var Ft=!1;e(window).hammer(St).on("tap","a.button.back#btnBack",function(){if(0==Ft){if(Ft=!0,"MissingDevicesPanel"==e(this).parents("panel.child").attr("id")&&(e("#MissingDevicesPanel").removeAttr("open").attr("right",""),e("#DevicesOnMapPanel").removeAttr("left").removeAttr("right").attr("open")),"InformationPanel"==e(this).parents("panel.child").attr("id")){if(e("#InformationPanel").removeAttr("open").attr("left",""),1==tt){e("#DevicesOnMapPanel").removeAttr("right").removeAttr("left").attr("open",""),e("#MissingDevicesPanel").removeAttr("right").removeAttr("left").removeAttr("open").attr("right",""),st.length=0;for(var t=0;t<z.length;t++)z[t].ID_Map==nt.ID_Map&&st.push(z[t]);st=d(st),At.empty(),h(),setTimeout(function(){At.MoveForward()},100),tt=!0}else e("#DevicesOnMapPanel").removeAttr("right").removeAttr("left").attr("open",""),e("#MissingDevicesPanel").removeAttr("right").removeAttr("left").removeAttr("open").attr("right","");if(1==DeviceAdd){e("#MissingDevicesPanel").removeAttr("right").removeAttr("left").attr("open",""),st.length=0,lt.length=0;for(var t=0;t<z.length;t++)z[t].ID_Map==nt.ID_Map&&st.push(z[t]),0==z[t].ID_Map&&lt.push(z[t]);st=d(st),lt=d(lt),At.empty(),Mt.empty(),h(),m(),setTimeout(function(){At.MoveForward(),Mt.MoveForward()},100),DeviceAdd=!0}else e("#DevicesOnMapPanel").removeAttr("right").removeAttr("left").attr("open",""),e("#MissingDevicesPanel").removeAttr("right").removeAttr("left").removeAttr("open").attr("right","")}if("DevicesOnMapPanel"==e(this).parents("panel.child").attr("id")&&(e("#DevicesOnMapPanel").removeAttr("open").attr("left",""),e("#MapsMasterPanel").removeAttr("right").removeAttr("left").attr("open","")),"GroupSelect"==e(this).parents("float.master").attr("id")){var r=e(this).parents("row.master").prev().find("panel[open]");null!=r.prev().attr("root")&&e("#GroupsMasterGroup").parent().next().attr("novis",""),e.each(e("#GroupsMasterGroup>panel.group").find("row.item"),function(t,o){e(o).attr("fullpath")==r.attr("child")&&(r.removeAttr("open").attr("right",""),e(o).parents("panel.child").removeAttr("left").removeAttr("right").attr("open",""))})}e("map>viewport>pog.selecteddevice").removeClass("selecteddevice")}setTimeout(function(){Ft=!1},700)}),e("#btnExit").hammer(St).on("tap",function(){navigator.app.exitApp()});var kt=!1;e(window).hammer(St).on("tap",".map",function(){if(0==kt){kt=!0;var t=e(this).attr("id");if(e("li.button.remove").removeClass("remove"),K.length=0,e("#deleteoptions").attr("novis",""),e("#deleteoptions").prev().removeAttr("novis"),nt.ID_Map==t)setTimeout(function(){e("#MapsMasterPanel").removeAttr("open").attr("right",""),e("#DevicesOnMapPanel").removeAttr("left").attr("open",""),gt.hide()},1);else{gt.show(),p();for(var r=0;r<H.length;r++)H[r].ID_Map==t&&(nt=H[r]);w(),setTimeout(function(){st.length=0,lt.length=0;for(var e=0;e<z.length;e++)z[e].ID_Map==nt.ID_Map&&st.push(z[e]),0==z[e].ID_Map&&lt.push(z[e]);st=d(st),lt=d(lt),At.empty(),Mt.empty(),h(),m(),setTimeout(function(){At.MoveForward()},100)},100),wt.maps(),console.log("ReadFile.maps second call")}}setTimeout(function(){kt=!1},200)});var Nt={preventDefault:!0,preventMouse:!0},xt={event:null,target:null,dist:0,maxdist:0,scrolling:!1,scrolltimeout:!1,dragging:!1},Gt=null;e("scroll.y").hammer(St).on("scroll",function(t){t.preventDefault(),0==xt.dragging?(e(xt.target).css("-webkit-transform",""),xt.event=null,xt.target=null,clearTimeout(Gt),xt.scrolltimeout=!0,Gt=setTimeout(function(){console.log("Timeout Scrolling"),xt.scrolltimeout=!1},500)):(t.preventDefault(),t.gesture.stopDetect())}),e(window).hammer(Nt).on("tap dragright dragup dragdown release",".mDevice",function(t){switch(t.type){case"tap":t.stopPropagation(),t.preventDefault();var r=e(this).attr("id");at=k(r),e.each(e("map>viewport>pog"),function(t,r){e(r).attr("id")==at.ID_Device&&e(r).addClass("selecteddevice")}),setTimeout(function(){e("#DevicesOnMapPanel").removeAttr("open").attr("right",""),e("#MissingDevicesPanel").removeAttr("open").attr("right",""),e("#InformationPanel").removeAttr("left").attr("open","")},10),I();break;case"dragright":0==xt.scrolltimeout&&0==xt.scrolltimeout&&(xt.dragging=!0,xt.event="dragright",xt.target=e(this),xt.maxdist=parseFloat(e(xt.target).width())/2/2,t.gesture.distance=Math.min(xt.maxdist,t.gesture.distance),e(xt.target).css("-webkit-transform","translate3d("+t.gesture.distance+"px,0px,0px)"),e(xt.target).parents("scroll").attr("scroll",e(xt.target).parents("scroll").scrollTop()),xt.dist=t.gesture.distance);break;case"release":if(0==xt.scrolltimeout&&0==xt.scrolltimeout){if(xt.dist==xt.maxdist&&"dragright"==xt.event){if(e(xt.target).hasClass("remove")){for(var o=0;o<K.length;o++)K[o]==e(xt.target).attr("id")&&(K.splice(o,1),e("#btnBinSelected").html(K.length+" selected"));try{e.each(e("map>viewport>pog"),function(t,r){e(r).attr("id")==e(xt.target).attr("id")&&e(r).removeClass("togDelete")})}catch(t){alert(t.toString()+" adding errror")}e(xt.target).removeClass("remove")}else{try{e.each(e("map>viewport>pog"),function(t,r){e(r).attr("id")==e(xt.target).attr("id")&&e(r).addClass("togDelete")})}catch(t){alert(t.toString()+" removal errror")}K.push(e(xt.target).attr("id")),e("#btnBinSelected").html(K.length+" selected"),e(xt.target).addClass("remove")}K.length>0?(e("#deleteoptions").removeAttr("novis"),e("#deleteoptions").prev().attr("novis","")):(e("#deleteoptions").attr("novis",""),e("#deleteoptions").prev().removeAttr("novis")),e(xt.target).css("-webkit-transform",""),e(xt.target).parents("scroll").scrollTop(e(xt.target).parents("scroll").attr("scroll")),xt.target=null,xt.event=null,xt.dist=0,xt.maxdist=0}else e(xt.target).css("-webkit-transform",""),xt.target=null;xt.dragging=!1}}}),e(window).hammer(Nt).on("tap drag dragright release",".uDevice",function(t){switch(t.type){case"drag":0==xt.scrolltimeout&&(t.gesture.center.pageX>e(this).parents("panel.master").width()?(e("#ulFloat").removeAttr("novis"),e("#ulFloat").css({left:t.gesture.center.pageX,top:t.gesture.center.pageY})):(e("#ulFloat").attr("novis",""),e("#ulFloat").css({left:0,top:0})));break;case"dragright":if(0==xt.scrolltimeout&&0==xt.scrolltimeout){null==xt.target&&(xt.target=e(this)),e(xt.target).parents("scroll").attr("scroll",e(xt.target).parents("scroll").scrollTop());var r=t.gesture.center.pageX-e(xt.target).width()/2/2;e(xt.target).css({"-webkit-transform":"translate3d("+r+"px,"+0+"px,0px)"}),e(xt.target).parents("scroll").css("overflow-y","hidden"),e(xt.target).parents("scroll").scrollTop(e(xt.target).parents("scroll").attr("scroll"))}break;case"release":if(0==xt.scrolltimeout&&0==xt.scrolltimeout){e(xt.target).css({"-webkit-transform":""}),e(xt.target).parents("scroll").css("overflow-y","auto"),e(xt.target).parents("scroll").scrollTop(e(xt.target).parents("scroll").attr("scroll"));var r=t.gesture.center.pageX,o=t.gesture.center.pageY,n=document.elementFromPoint(r,o);"IMG"==n.nodeName||"POG"==n.nodeName?(e("#ulFloat").attr("value",e(xt.target).attr("id")),K.length=0,e("#deleteoptions").attr("novis",""),e("#deleteoptions").prev().removeAttr("novis"),e("#btnBinSelected").html(" 0 "),i(r,o),e("#ulFloat").attr("novis",""),e("#ulFloat").css({left:"",top:""}),e("#ulFloat").attr("value",null)):(e("#ulFloat").attr("novis",""),e("#ulFloat").css({left:"",top:""}),e("#ulFloat").attr("value",null)),xt.target=null}}}),e(window).hammer(St).on("tap","map>viewport>pog",function(){e("map>viewport>pog.selecteddevice").removeClass("selecteddevice");var t=k(e(this).attr("id"));at=t,e(this).addClass("selecteddevice"),setTimeout(function(){e("#DevicesOnMapPanel").removeAttr("open").attr("right",""),e("#InformationPanel").removeAttr("left").attr("open",""),e("#MissingDevicesPanel").removeAttr("open").attr("right","")},10),I()});var Ot={startObj:null,delta:{x:0,y:0},dtObj:null,doubletap:!1};e(document.body).hammer().on("dragstart drag dragend","map>viewport>pog.unlocked",function(t){switch(e("map>viewport>pog.selecteddevice").removeClass("selecteddevice"),t.type){case"dragstart":var r=k(e(this).attr("id"));at=r,I(),Ot.startObj=e(this);break;case"drag":var o=e("map").position(),n={w:e("map>viewport>img").width(),h:e("map>viewport>img").height()},a=e("map>viewport>img").attr("offset").split(" ")[0],i=e("map>viewport>img").attr("offset").split(" ")[1],s=10,l=parseFloat(n.w)-2*s,c=parseFloat(n.h)-s;Ot.delta.x=t.gesture.center.pageX-parseFloat(o.left)-parseFloat(a),Ot.delta.y=t.gesture.center.pageY-parseFloat(o.top)-parseFloat(i),Ot.delta.x=Math.max(s,Ot.delta.x),Ot.delta.y=Math.max(s,Ot.delta.y),Ot.delta.x=Math.min(l,Ot.delta.x),Ot.delta.y=Math.min(c,Ot.delta.y);var p="",u="1,0,0,-1",d="1,0, 0, 1",t="0,-1, 1, 0",g="0, 1, -1, 0";p=d,Ot.delta.x<70&&(p=g),Ot.delta.x>parseFloat(n.w)-70&&(p=t),Ot.delta.y<70&&(p=u),e(Ot.startObj).css({"-webkit-transform":"matrix("+p+","+Ot.delta.x+","+Ot.delta.y+")"});for(var h=0;h<z.length;h++)z[h].ID_Device==e(Ot.startObj).attr("id")&&(z[h].X=Ot.delta.x/parseFloat(e("map>viewport>img").width())*B,z[h].Y=Ot.delta.y/parseFloat(e("map>viewport>img").height())*q,at.ID_Device==z[h].ID_Device&&e("#infoDevicePosition").val(z[h].X.toFixed(0)+" : "+z[h].Y.toFixed(0)));break;case"dragend":console.log("Drag end");var m=e(Ot.startObj).css("-webkit-transform");m=m.substr(m.lastIndexOf("(")).replace(/\(|\)/g,"").split(", ");var v=parseFloat(m[4]),f=parseFloat(m[5]);v=v/parseFloat(e("map>viewport>img").width())*B,f=f/parseFloat(e("map>viewport>img").height())*q;for(var h=0;h<z.length;h++)z[h].ID_Device==e(Ot.startObj).attr("id")&&(z[h].X=v,z[h].Y=f,T(z[h].ID_Device,"position",z[h].X.toFixed(0)+" "+z[h].Y.toFixed(0)),at.ID_Device==z[h].ID_Device&&e("#infoDevicePosition").val(z[h].X.toFixed(0)+" : "+z[h].Y.toFixed(0)));Ot.startObj=null}}),e("map>viewport").hammer(St).on("transformstart transform transformend",function(t){switch(t.preventDefault(),t.type){case"transformstart":L.start=t.gesture.center;break;case"transform":L.scale=Math.max(1,t.gesture.scale*L.oldScale),L.scale=Math.min(5,L.scale),L.matrix=e(this).css("-webkit-transform").replace(/(matrix)|([\()])/g," ").split(","),e(this).css("-webkit-transform","matrix("+L.scale+",0,0,"+L.scale+",0,0)");break;case"transformend":L.oldScale=L.scale,L.end=t.gesture.center}}),e("#inputselectGroup").parent().hammer(St).on("tap",function(){e("#MapTitle").empty().html("OneStop"),null!=e("float#GroupSelect").attr("novis")&&(ct.show(),setTimeout(function(){p(),c(),ot=!1,nt=new Object,at=new Object,lt.length=0,st.length=0,e("float#GroupSelect").removeAttr("novis")},10))}),e(window).hammer(St).on("tap","a.button.close",function(){ct.hide(),e(this).parents("float.master").attr("novis",""),"logbook"==e(this).parents("float.master").attr("id")&&e("#logbookLog").children(".master").removeClass("expand").removeClass("collapse").addClass("expand"),setTimeout(function(){},10)});var _t=!1;e(window).hammer(St).on("tap","a.button.hasKids",function(){if(gt.show(),0==_t){var t=e(this).parent().attr("fullPath");yt.MoveForward(t),_t=!0}setTimeout(function(){_t=!1},700)}),e(window).hammer(St).on("tap",".isselected",function(){console.log("HAMMER TIME!"),console.log(this);var t=e(this).parent().attr("groupid");if(0==_t){for(var r=0;r<V.length;r++)V[r].ID_Group==t&&(A(r),console.log("changeGroup called from event"));_t=!0,setTimeout(function(){e("float#GroupSelect").attr("novis",""),ct.hide()},100)}setTimeout(function(){_t=!1},700)}),e("#btnExtSelectCancel").hammer(St).on("tap",function(){try{ExtSelect.hide()}catch(e){console.log(e)}}),e("panel[right]>swipe").hammer(St).on("tap dragright swiperight dragleft swipeleft",function(t){e("#btnTogPanel").trigger("tap"),t.stopPropagation(),t.preventDefault(),t.gesture.stopDetect()}),e("#btnDeviceImageClose").hammer(St).on("tap",function(){e(this).parents("display.master").attr("novis","")}),e("#btnDeviceImage").hammer(St).on("tap",function(){ct.show(),ht.show(),wt.devImg()}),e("#btnUsePhoto").hammer(St).on("tap",function(){ht.hide(),ht.ClearImage(),setTimeout(function(){vt.getCameraroll()},10)}),e("#btnNewPhoto").hammer(St).on("tap",function(){ht.hide(),ht.ClearImage(),setTimeout(function(){vt.getPicture()},10)}),e("row.item>label.text").hammer(St).on("tap",function(){console.log(" working ");var t=e(this).children("input").attr("id"),r=["Ok","Cancel"];switch(console.log(t),t){case"infoDeviceAssetNumber":O("Give the device a new Asset Number",function(e){1==e.buttonIndex&&b(e.input1,"assetnumber")},"Asset Number",r,at.AssetNumber);break;case"infoDeviceDescription":O("Give the device a new description",function(e){1==e.buttonIndex&&b(e.input1,"description")},"Device Description",r,at.Description);break;case"infoDeviceLocation":O("Change location",function(e){1==e.buttonIndex&&b(e.input1,"location")},"Device Location",r,at.Location);break;case"infoDeviceSerialNumber":O("Change the serial number",function(e){1==e.buttonIndex&&b(e.input1,"serialnumber")},"Serial Number",r,at.SerialNumber);break;case"infoDevicePosition":return 0}}),e("a.button.locate").hammer(St).on("tap",function(){e.each(e("map>viewport>pog"),function(t,r){e(r).attr("id")==at.ID_Device&&e(r).addClass("selecteddevice")})}),e("#infoDeviceLock").hammer(St).on("change",function(){b(e("#infoDeviceLock").prop("checked"),"locked")}),e(window).hammer(St).on("tap","dropdown.head",function(){e(this).parent().toggleClass("expand").toggleClass("collapse"),e(this).next().children().removeClass("collapse").addClass("expand")}),e("#btnClearLog").hammer(St).on("tap",function(){e("#logbookLog").empty()}),e("#inputUsername, #inputPassword").on("focus blur",function(t){"focus"==t.type&&e(this).focus(),e(this).parents("div").css({"margin-bottom":"50%"}),"blur"==t.type&&e(this).parents("div").css({"margin-bottom":"0%"})}),e("#btnAddDevices").hammer(St).on("tap",function(){Q||(Q=!0,e(this).parents("panel.child").removeAttr("left").attr("left",""),e("#MissingDevicesPanel").removeAttr("right").attr("open",""),Mt.empty(),gt.show(),m(),setTimeout(function(){Mt.MoveForward()},500),setTimeout(function(){Q=!1},700))}),e("#btnSearch").hammer(St).on("tap",function(){null!=e("#GroupSearch").attr("novis")?(e("#GroupSearch").removeAttr("novis"),e(".autoComplete").focus()):e("#GroupSearch").attr("novis","")}),e("#btnTest").hammer(St).on("tap",function(){mt.groups()}),e("shadow").hammer(St).on("touch release",function(){e("float#GroupSelect").attr("novis")||e("float#GroupSelect").attr("novis",""),e("#logbook").attr("novis")||(e("#logbook").attr("novis",""),e("#logbookLog").children(".master").removeClass("expand").removeClass("collapse").addClass("expand")),e("#DeviceImageDisplay").attr("novis")||ht.hide(),ct.hide()}),e(window).hammer(St).on("tap","a.button#btnforwards_Off",function(){Mt.MoveForward()}),e(window).hammer(St).on("tap","a.button#btnbackwards_Off",function(){Mt.MoveBackward()}),e(window).hammer(St).on("tap","a.button#btnforwards_On",function(){At.MoveForward()}),e(window).hammer(St).on("tap","a.button#btnbackwards_On",function(){At.MoveBackward()}),e(window).hammer(St).on("tap","a.button#btnforwards",function(){var t=e(this).prev("indicator"),r=parseInt(t.html()),o=e(this).parents("row.master")[0];if(o=e(o).prev(),0!=o.children("panel[open]").next().length&&!$){var n=o.children("panel[open]"),a=n.next();a.show(),$=!0,t.html(r+=1),setTimeout(function(){n.removeAttr("open").attr("left",""),a.show().removeAttr("right").attr("open","")},0),setTimeout(function(){$=!1,n.hide()},700)}}),e(window).hammer(St).on("tap","a.button#btnbackwards",function(){var t=e(this).next("indicator"),r=parseInt(t.html()),o=e(this).parents("row.master")[0];if(o=e(o).prev(),0!=o.children("panel[open]").prev().length&&!$){var n=o.children("panel[open]"),a=n.prev();a.show(),$=!0,t.html(r-=1),setTimeout(function(){n.removeAttr("open").attr("right",""),a.removeAttr("left").attr("open","")},0),setTimeout(function(){$=!1,n.hide()},700)}}),e(window,document).on("submit",function(e){return e.preventDefault(),!1}),e(window).hammer(St).on("touch","input",function(e){e.preventDefault()}),e(".autoComplete").tinyAutocomplete({data:V,onSelect:function(t,r){null==r?e(".autoCompleteResults").html('All results for "'+e(this).val()+'" would go here'):(e(this).val(r.Name),console.log(e(this).val(r.Name)),e(".autoCompleteResults").html("<h1>"+r.Name+"</h1>"))}})}catch(Ct){alert(Ct.toString()),console.log(Ct.toString())}});