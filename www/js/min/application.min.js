Zepto(function(e){function t(e){window.localStorage.setItem("serverAddress",e),Y=e,V=Y+"/mobile.asmx"}function r(t,r){Y?(document.activeElement.blur(),e(document).blur(),e.ajax({type:"POST",url:V+"/UserLogin",contentType:"application/json; charset=utf-8",async:!0,data:JSON.stringify({login:t,pass:r}),dataType:"json",success:function(e){console.log(e.d),W=JSON.parse(e.d),0!=W?(ot.changes=0,ot.logged=!0,ot.logTime=N(),ot.user=W,y("Login successful","short","top"),setTimeout(function(){wt.settings(),y("user.ID_Group = "+ot.user.ID_Group,"long","top")},10)):setTimeout(function(){mt.hide(),y("Incorrect Login details","short","top")},50)},error:function(e,t){setTimeout(function(){mt.hide(),y("Ajax error : "+t.toString(),"long","top")},50)}})):y("Please enter an IP address in the settings page","long","top")}function o(){return 1==E.Browser?window.TEMPORARY:LocalFileSystem.PERSISTENT}function n(e){if(1==E.Browser){var t=x(e),r=new Blob([t],{type:"text/plain"});return r}var r=x(e);return r}function a(t){nt=!0;var r=new Image;e("map>viewport").css({"-webkit-transform":"matrix(1,0,0,1,0,0)"}),e("map>viewport>img").attr({src:" ",width:"0",height:"0"}).css({"-webkit-transform":"matrix(1,0,0,1,0,0)"}),e("viewport>pog").remove(),r.src=t,r.onload=function(){var t,o,n=r.width,a=r.height,i=e("map").height()/a,t=i*n,o=i*a;t>e("map").width()&&(i=e("map").width()/t,t=i*t,o=i*o);var l=e("map").width()/2-t/2,c=e("map").height()/2-o/2;e("map>viewport>img").attr({src:r.src,width:t,height:o,offset:l+" "+c}).css({"-webkit-transform":"matrix(1,0,0,1,"+l+","+c+")"}),s(),setTimeout(function(){e("#MapsMasterPanel").removeAttr("open").attr("right",""),e("#DevicesOnMapPanel").removeAttr("left").attr("open",""),mt.hide()},10)}}function i(t,r){DeviceAdd=!0,Mt.empty(),It.empty();var o=e("map").position();t-=parseFloat(o.left),r-=parseFloat(o.top);var n=e("map>viewport>img").css("-webkit-transform");n=n.substr(n.lastIndexOf("(")).replace(/\(|\)/g,"").split(", ");var a=n[5],i=n[4];t-=i,r-=a,t=parseFloat(t)/parseFloat(e("map>viewport>img").width())*q,r=parseFloat(r)/parseFloat(e("map>viewport>img").height())*J;for(var l,c=0;c<H.length;c++)if(H[c].ID_Device==e("#ulFloat").attr("value")){l=H[c].ID_Device,H[c].X=t,H[c].Y=r,H[c].ID_Map=at.ID_Map,H[c].Image="devimg/default.png";var p=st.ID_Group+",";p+=at.ID_Map+",",p+=parseInt(t)+","+parseInt(r)+",",p+=!1+"",S(H[c].ID_Device,p.toString())}e("#MissingDevicesPanel").removeAttr("open").attr("right",""),e("#InformationPanel").removeAttr("left").attr("open",""),setTimeout(function(){s(),it=k(l),e.each(e("map>viewport>pog"),function(t,r){e(r).attr("id")==it.ID_Device&&e(r).addClass("selecteddevice")}),I()},10)}function s(){c(),e("viewport>pog").remove();var t="",r=e("map>viewport>img").css("-webkit-transform");r=r.substr(r.lastIndexOf("(")).replace(/\(|\)/g,"").split(", ");for(var o=r[5],n=r[4],a=0;a<H.length;a++)if(H[a].ID_Map==at.ID_Map){var i=parseFloat(H[a].X)/q*parseFloat(e("map>viewport>img").width()),s=parseFloat(H[a].Y)/J*parseFloat(e("map>viewport>img").height()),l="";l=100>s?"1,0,0,-1":100>i?"0,-1,-1,0":i>q-100?"0,-1,1,0":"1,0,0,1";var p="-webkit-transform: matrix("+l+","+i+","+s+"); top:"+o+"; left:"+n+";",u=1==H[a].Locked?"locked":"unlocked";console.log(u),t+="<pog style='"+p+"' class='"+u+"'id='"+H[a].ID_Device+"'></pog>"}e("map>viewport").append(t)}function l(){if(1==nt){c(),e("map>viewport").css({"-webkit-transform":"matrix(1,0,0,1,0,0)"}),e("map>viewport>img").css({"-webkit-transform":"matrix(1,0,0,1,0,0)"});var t,r,o=e("map>viewport>img").width(),n=e("map>viewport>img").height();console.log(o+" "+n);var a=e("map").height()/n;r=a*n,t=a*o,t>e("map").width()&&(a=e("map").width()/t,r=a*r,t=a*t),console.log(r+" "+t);var i=e("map").width()/2-t/2,l=e("map").height()/2-r/2;i=Math.round(i),l=Math.round(l),e("map>viewport>img").attr({width:t,height:r,offset:i+" "+l}).css({"-webkit-transform":"matrix(1,0,0,1,"+i+","+l+")"}),s()}}function c(){e("viewport>pog").remove()}function p(){nt=!1,e("map>viewport").css({"-webkit-transform":"matrix(1,0,0,1,0,0)"}),e("map>viewport>img").attr({src:"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",width:"0",height:"0"}).css({"-webkit-transform":"matrix(1,0,0,1,0,0)"})}function u(t){var r=N(),o="";o+='<dropdown class="master expand"><dropdown class="head"><p>'+r+'</p><a href="#" class="button"></a></dropdown><dropdown class="content">';for(var n=0;n<t.length;n++){null==t[n].ID&&(t[n].ID="Unknown Device"),o+='<dropdown class="master expand"><dropdown class="head"><p>'+t[n].ID+'</p><a href="#" class="button"></a></dropdown><dropdown class="content">';for(var a=0;a<t[n].Tasks.length;a++)console.log(""),o+='<row class="item"><p>'+t[n].Tasks[a].Type+"</p><p>"+t[n].Tasks[a].Value+"</p></row>";o+="</dropdown></dropdown>"}o+="</dropdown></dropdown>",e("#logbookLog").prepend(o)}function d(e){for(var t=e.slice(0),r=new Array,o=new Array;t.length>0;)r.push(t[0]),r.length==X&&(o.push(r),r=new Array),t.splice(0,1);return 0!=r.length&&(o.push(r),r=new Array),o}function g(){if(e("#infoMapNum").val("Number of Maps : "+Z.length),console.log("Number of Maps : "+Z.length),Z.length>0){var t=Z.slice(0);t=d(t);var r="";r+="<panel class='group'>";for(var o=0;o<t.length;o++){r+="<panel right class='child'><scroll class='y'><row class='content'>";for(var n=0;n<t[o].length;n++){var a=t[o][n].Name,i=t[o][n].Description,s=t[o][n].ID_Map;(0==a.length||null==a)&&(a="Name unavalible"),0==i.length&&(i="No description"),r+="<row class='button item map' id='"+s+"'><span><name>"+a+"</name><serial>"+i+"</serial></span></row>"}r+="</row></scroll></panel>"}r+="</panel>",t.length>1&&(r+='<row class="master" style="-webkit-box-flex: 1; min-height: 40px;max-height: 40px;"><row class="back"><a href="#" class="button backward" id="btnBackwards"></a><indicator>1</indicator><a href="#" class="button forward" id="btnforwards"></a></row></row>'),e("#MapsMasterGroup").empty().append(r),e("#MapsMasterGroup>panel.group").children().hide(),setTimeout(function(){e("#MapsMasterGroup>panel.group>panel:first-child").attr("open","").removeAttr("left").removeAttr("right").show()},1),r.length=0}else{var r="";r+="<row class='item none' id='none'><span><name>No Maps</name><serial>This group contains no maps</serial></span></row>",console.log("Drawing"),e("#MapsMasterGroup").empty().append(r),r.length=0}}function m(){var t="";t+="<row class='item none' id='none'><span><name>Loading Devices</name><serial>This may take some time.</serial></span></row>",console.log("Drawing"),e("#DevicesonMapGroup").empty().append(t),t.length=0}function h(){var t="";t+="<row class='item none' id='none'><span><name>Loading Devices..</name><serial>This may take some time.</serial></span></row>",e("#MissingDevicesGroups").empty().append(t),t.length=0}function v(){e("#infoDeviceNum").val("Number of Devices : "+H.length)}function f(){var t=ot.lastUpdate.replace(/\"/g," ");t.length>0?e("#infoDownloadDate").val(t):e("#infoDownloadDate").val("Unknown Date")}function w(){at.Description?e("#MapTitle").empty().html(at.Name):e("#MapTitle").empty().html("OneStop")}function D(){return L.online}function b(t,r){for(var o=0;o<H.length;o++)H[o].ID_Device==it.ID_Device&&("locked"==r&&(H[o].Locked=t,e.each(e("map>viewport>pog"),function(t,r){e(r).attr("id")==H[o].ID_Device&&e(r).toggleClass("unlocked").toggleClass("locked")}),T(it.ID_Device,"lock",t),it=H[o],rt=!0),"description"==r&&(H[o].Description=t,T(it.ID_Device,"description",t),e("#infoDeviceDescription").val(it.Description),it=H[o],I(),rt=!0),"location"==r&&(H[o].Location=t,T(it.ID_Device,"location",t),e("#infoDeviceLocation").val(it.Location),it=H[o],I(),rt=!0),"serialnumber"==r&&(H[o].SerialNumber=t,T(it.ID_Device,"serialnumber",t),e("#infoDeviceSerialNumber").val(it.SerialNumber),it=H[o],I(),rt=!0),"assetnumber"==r&&(H[o].AssetNumber=t,T(it.ID_Device,"assetnumber",t),e("#infoDeviceAssetNumber").val(it.AssetNumber),it=H[o],I(),rt=!0))}function y(e,t,r){0==E.Browser?window.plugins.toast.show(e,t,r,function(){},function(e){alert("Toast Error"+e)}):console.log(e)}function A(t){try{p(),c(),l(),at.length=0,it=0,Z.length=0,H.length=0,lt.length=0,ct.length=0,Mt.empty(),It.empty(),Q.length=0,e("li.button.remove").removeClass("remove"),e("#btnBinSelected").html(Q.length+" selected"),e("#deleteoptions").attr("novis",""),e("#deleteoptions").prev().removeAttr("novis"),st=z[t],console.log("CurrentGroup = "),console.log(st),e("#inputselectGroup").val(st.ID_Group+" - "+st.Name),mt.show(),Dt.data()}catch(r){alert("trying changeGroup with num "+t+" error: "+r.toString())}}function M(){e("#imageDevice").css("background-image","url(./img/icon.png)"),e("#infoDevicePosition").val(""),e("#infoDeviceDescription").val(""),e("#infoDeviceLocation").val(""),e("#infoDeviceSerialNumber").val(""),e("#infoDeviceAssetNumber").val(""),e("#infoDeviceLock").prop("checked",0)}function I(){ht.ClearImage(),e("#infoDevicePosition").val(it.X.toFixed(0)+" : "+it.Y.toFixed(0)),e("#infoDeviceDescription").val(it.Description),""==it.Location||null==it.Location?e("#infoDeviceLocation").val("No Location"):e("#infoDeviceLocation").val(it.Location),""==it.SerialNumber||null==it.SerialNumber?e("#infoDeviceSerialNumber").val("No Serial"):e("#infoDeviceSerialNumber").val(it.SerialNumber),""==it.AssetNumber||null==it.AssetNumber?e("#infoDeviceAssetNumber").val("No Asset Number"):e("#infoDeviceAssetNumber").val(it.AssetNumber),1==it.Locked?e("#infoDeviceLock").prop("checked",1):e("#infoDeviceLock").prop("checked",0)}function T(e,t,r){var o={Type:"save",Attribute:t,Value:r};if(K.length>0){for(var n=!1,a=0;a<K.length;a++)K[a].ID==e&&(n=!0,K[a].Tasks.push(o));0==n&&(console.log(e+"Add to End"),K.push({ID:e,Tasks:[]}),K[K.length-1].Tasks.push(o))}else K.push({ID:e,Tasks:[]}),K[K.length-1].Tasks.push(o)}function S(e,t){var r={Type:"insert",Value:t};if(K.length>0){for(var o=!1,n=0;n<K.length;n++)K[n].ID==e&&(o=!0,K[n].Tasks.push(r));0==o&&(K.push({ID:e,Tasks:[]}),K[K.length-1].Tasks.push(r))}else K.push({ID:e,Tasks:[]}),K[K.length-1].Tasks.push(r)}function F(e){var t={Type:"remove",Attribute:null,Value:null};if(K.length>0){for(var r=!1,o=0;o<K.length;o++)K[o].ID==e&&(r=!0,K[o].Tasks.push(t));0==r&&(K.push({ID:e,Tasks:[]}),K[K.length-1].Tasks.push(t))}else K.push({ID:e,Tasks:[]}),K[K.length-1].Tasks.push(t)}function k(e){for(var t=0;t<H.length;t++)if(H[t].ID_Device==e)return H[t]}function N(){var e=new Date;return e.toUTCString()}function x(e){return JSON.stringify(e)}function x(e){return JSON.stringify(e)}function G(e,t,r,o){navigator.notification.confirm(e,t,r,o)}function _(e,t,r,o,n){navigator.notification.prompt(e,t,r,o,n)}function O(){e("#btnTogPanel").trigger("tap"),R=!0,1==E.Browser||navigator.splashscreen.hide()}function C(e){console.log("your comment was saved : "+e)}function P(){console.log("getting first group"),e("#GroupPanel>panel.group").empty();for(var t=z[0].ID_Group,r=0;r<z.length;r++)z[r].ID_Group==t&&(A(r),console.log("changeGroup called from GetFirstGroup"));At.MoveForward()}try{var R=!1,E={IOS:!!e.os.ios,Android:!!e.os.android,Version:e.os.version,Browser:!1},L={status:"offline",type:"none",online:!1};E.Browser=!0,e.each(e("scroll.y"),function(t,r){e(r).css({width:"100%","max-width":e(r).width(),"min-width":e(r).width()})});var U={start:{},end:{},center:{},dist:{},oldScale:1,scale:1,matrix:null};E.IOS&&(e("#deviceStyle").attr("href","css/ios.css"),parseFloat(E.Version)>=7&&e("page").css({"padding-top":"20px"})),E.Android&&e("#deviceStyle").attr("href","css/android.css"),E.Android||E.IOS||e("#deviceStyle").attr("href","css/android.css");var j,B=!0,q=1e3,J=750,X=30,Y=window.localStorage.getItem("serverAddress"),V=Y+"/mobile.asmx";1==E.Browser?(window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,j=0):j=0,String.prototype.capitalize=function(){return this.replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()})};var W=new Object,z=new Array,H=new Array,Z=new Array,K=new Array,Q=new Array,$=!1,et=!1,tt=!1,rt=!1,ot={logged:!1,logTime:"",user:new Object,lastUpdate:"",changes:0},nt=!1,at=new Object,it=new Object,st=new Object,lt=new Array,ct=new Array,pt={show:function(){""==e("shadow").attr("novis")&&e("shadow").removeAttr("novis")},hide:function(){e("shadow").attr("novis","")}},ut={show:function(){e("#login").removeAttr("novis")},hide:function(){e("#login").attr("novis","")}},dt={show:function(){e("#settings").removeAttr("novis")},hide:function(){e("#settings").attr("novis","")}},gt={show:function(){console.log("***showing main page!"),e("#main").removeAttr("novis")},hide:function(){e("#main").attr("novis","")}},mt={show:function(){E.Browser||window.plugins.spinnerDialog.show()},hide:function(){E.Browser||window.plugins.spinnerDialog.hide()}},ht={show:function(){e("#DeviceImageDisplay").removeAttr("novis")},hide:function(){e("#DeviceImageDisplay").attr("novis","")},loadImage:function(t){e("#DeviceImageDisplay>display.content").empty().append("<img/>");var r=e("#DeviceImageDisplay>display.content>img"),o=new Image;o.src=t,o.onload=function(){var e,t,n=o.width,a=o.height;if(a<r.parent().height()&&n<r.parent().width()){var i=Math.round(r.parent().width()/2-n/2),s=Math.round(r.parent().height()/2-a/2);console.log(i+" "+s),r.width(n),r.height(a),r.attr("src",o.src),r.css({"-webkit-transform":"matrix(1,0,0,1,1,"+s+")"})}else{var l=r.parent().height()/a,t=a*l,e=n*l;e>r.parent().width()&&(l=r.parent().width()/e,e=l*e,t=l*t);var i=Math.round(r.parent().width()/2-e/2),s=Math.round(r.parent().height()/2-t/2);console.log(i+" "+s),r.width(e),r.height(t),r.attr("src",o.src),r.css({"-webkit-transform":"matrix(1,0,0,1,1,"+s+")"})}}},ClearImage:function(){e("#DeviceImageDisplay>display.content").empty()},Resizemage:function(){if(null==e("#DeviceImageDisplay").attr("novis")){console.log("Resizing"),console.log(e("#DeviceImageDisplay").attr("novis"));var t,r,o=e("#DeviceImageDisplay>display.content>img"),n=o.width(),a=o.height();if(a<o.parent().height()&&n<o.parent().width()){Math.round(o.parent().width()/2-n/2);var i=Math.round(o.parent().height()/2-a/2);o.width(n),o.height(a),o.css({"-webkit-transform":"matrix(1,0,0,1,1,"+i+")"})}else{var s=o.parent().height()/a,r=a*s,t=n*s;t>o.parent().width()&&(s=o.parent().width()/t,t*=s,r*=s),Math.round(o.parent().width()/2-t/2);var i=Math.round(o.parent().height()/2-r/2);o.width(t),o.height(r),o.css({"-webkit-transform":"matrix(1,0,0,1,1,"+i+")"})}}}},vt={groups:function(){console.log("Using AJAX to get groups"),e.ajax({type:"POST",url:V+"/GetAvalibleGroups",contentType:"application/json; charset=utf-8",async:!0,data:JSON.stringify({data:ot.user.ID_Group}),dataType:"json",success:function(e){z=JSON.parse(e.d),0!=z&&wt.groups()},error:function(){}})},maps:function(){e.ajax({type:"POST",url:V+"/GetMaps",contentType:"application/json; charset=utf-8",async:!0,data:JSON.stringify({data:st.ID_Group}),dataType:"json",success:function(e){0==e.d?Z.length=0:Z=JSON.parse(e.d),vt.devices()},error:function(){}})},devices:function(){e.ajax({type:"POST",url:V+"/GetDevices",contentType:"application/json; charset=utf-8",async:!0,data:JSON.stringify({data:st.ID_Group}),dataType:"json",success:function(e){0==e.d?H.length=0:H=JSON.parse(e.d),ot.lastUpdate=N(),wt.data(),y("Data downloaded","short","top")},error:function(){}})},changes:function(){K[K.length-1].Date&&K.splice(K.length-1,1),e.ajax({type:"POST",url:V+"/Tasks",contentType:"application/json; charset=utf-8",async:!0,data:JSON.stringify({todo:K}),success:function(e){K.length=0,ot.changes=0;var t=JSON.parse(e.d);console.log(t),u(t),bt.changes(),Q.length=0,setTimeout(function(){wt.settings(),wt.data(),y("Upload finished - Check log","short","top"),setTimeout(function(){lt.length=0,ct.length=0;for(var e=0;e<H.length;e++)H[e].ID_Map==at.ID_Map&&lt.push(H[e]),0==H[e].ID_Map&&ct.push(H[e]);lt=d(lt),ct=d(ct),Mt.empty(),It.empty(),m(),h(),setTimeout(function(){Mt.MoveForward()},100)},100),s()},100)},error:function(t,r){alert(r),e("#logbookLog").append("<p>"+r+"</p>"),mt.hide(),y("Upload failed","short","top")}})}},ft={getPicture:function(){try{navigator.camera.getPicture(ft.pictureSuccess,ft.pictureFail,{quality:50,destinationType:navigator.camera.DestinationType.FILE_URI,sourceType:navigator.camera.PictureSourceType.CAMERA,encodingType:navigator.camera.EncodingType.JPEG,saveToPhotoAlbum:!0})}catch(e){alert(e.toString())}},getCameraroll:function(){try{navigator.camera.getPicture(ft.pictureSuccess,ft.pictureFail,{quality:50,destinationType:navigator.camera.DestinationType.FILE_URI,sourceType:navigator.camera.PictureSourceType.PHOTOLIBRARY,encodingType:navigator.camera.EncodingType.JPEG})}catch(e){alert(e.toString())}},pictureSuccess:function(e){try{var t=e.substr(e.lastIndexOf("/")+1);setTimeout(function(){_("Give the image a name",function(r){if(1==r.buttonIndex){t=r.input1+".jpg";for(var o=0;o<H.length;o++)H[o].ID_Device==it.ID_Device&&(H[o].Image="devimg/"+t,it=H[o]);T(it.ID_Device,"image","devimg/"+t),wt.data(),ft.copyImageToDir(e,t)}},"Device Image",["Done","Cancel"],it.Description)},10)}catch(r){alert(x(r))}},pictureFail:function(){alert("Camera Fail: "+Pt.toString())},copyImageToDir:function(e,t){var r="";setTimeout(function(){window.requestFileSystem(o(),j,function(o){o.root.getDirectory("OSMobile/devimg",{create:!0},function(o){r=o.toURL(),window.resolveLocalFileSystemURI(e,function(o){window.resolveLocalFileSystemURI(r,function(r){o.copyTo(r,t,function(){if(1==D())try{var r=V+"/SaveImage",o=new FileUploadOptions;o.fileKey="file",o.fileName=t,o.mimeType="image/jpeg";var n=new FileTransfer;n.upload(e,r,function(){y("Image uploaded","short","top"),I(),ht.hide(),setTimeout(function(){ht.show(),Dt.devImg()},10)},function(e){alert("Upload Transfer error: "+x(e))},o)}catch(a){alert("Upload error: "+a.toString())}else y("Unable to uplaod device image","long","top")},function(e){switch(e.code){case 12:alert("Copy Failure: Device image with that name already exists");break;default:alert(e.code)}})},yt.error)},yt.error)},yt.error)},yt.error)},100)}},wt={settings:function(){var e="settings.json",t=ot;window.requestFileSystem(o(),j,function(r){r.root.getDirectory("OSMobile",{create:!0},function(r){r.getFile(e,{create:!0},function(r){r.createWriter(function(r){r.onwritestart=function(){console.log("Writing File: "+e)},r.onwriteend=function(){console.log("Write complete: "+e),0==z.length&&vt.groups()},r.write(n(t))},yt.error)},yt.error)},yt.error)},yt.error)},groups:function(){var e="groups.json",t=z;window.requestFileSystem(o(),j,function(r){r.root.getDirectory("OSMobile/data",{create:!0},function(r){r.getFile(e,{create:!0},function(r){r.createWriter(function(r){r.onwritestart=function(){console.log("Writing File: "+e)},r.onwriteend=function(){console.log("Write complete: "+e),P(),setTimeout(function(){ut.hide(),dt.hide(),gt.show(),mt.hide()},50)},r.write(n(t))},yt.error)},yt.error)},yt.error)},yt.error)},data:function(){var e=st.ID_Group+".json",t=new Object;t.Date=N(),t.Maps=Z,t.Devices=H,window.requestFileSystem(o(),j,function(r){r.root.getDirectory("OSMobile/data",{create:!0},function(r){r.getFile(e,{create:!0},function(r){r.createWriter(function(r){r.onwritestart=function(){console.log("Writing File: "+e)},r.onwriteend=function(){console.log("Write complete: "+e),g(),console.log("DrawAvalibleMaps - writefile.data"),v(),f(),mt.hide()},r.write(n(t))},yt.error)},yt.error)},yt.error)},yt.error)},changes:function(){var e,t="changes.json";K.splice(K.length,1),K.push({Date:N()}),e=K,window.requestFileSystem(o(),j,function(r){r.root.getDirectory("OSMobile",{create:!0},function(r){r.getFile(t,{create:!0},function(r){r.createWriter(function(r){r.onwritestart=function(){console.log("Writing File: "+t)},r.onwriteend=function(){K.length=0},r.write(n(e))},yt.error)},yt.error)},yt.error)},yt.error)}},Dt={settings:function(){var t="settings.json";window.requestFileSystem(o(),j,function(r){r.root.getDirectory("OSMobile",{create:!0},function(r){r.getFile(t,{create:!1},function(t){t.file(function(t){var r=new FileReader;r.onload=function(){if(this.result.length>0){var t=JSON.parse(this.result);ot=t,1==ot.logged?(console.log("setings = "),console.log(ot),e("#inputPrevUsername").val(ot.user.Name),e("#inputLogTime").val(ot.logTime)):console.log("Not logged in"),0==R&&O()}else e("#inputPrevUsername").val("No previous user"),e("#inputLogTime").val("  "),0==R&&O()},r.readAsText(t)},yt.error)},function(t){1==t.code?(console.log("Settings file not found."),e("#inputPrevUsername").val("No previous user"),e("#inputLogTime").val("  "),0==R&&O()):yt.error(t)})},yt.error)},yt.error)},groups:function(){var t="groups.json";window.requestFileSystem(o(),j,function(r){r.root.getDirectory("OSMobile/data",{create:!0},function(r){r.getFile(t,{create:!1},function(t){t.file(function(t){var r=new FileReader;r.onload=function(){if(console.log("Reading Groups File"),this.result.length>0){console.log(this.result);var t=JSON.parse(this.result);z.length=0;for(var r=0;r<t.length;r++)z.push(t[r]);P(),setTimeout(function(){ut.hide(),dt.hide(),gt.show(),mt.hide(),e("#btnTogPanel").trigger("tap")},50)}else console.log("No Groups")},r.readAsText(t)},yt.error)},function(e){1==e.code?(1==D()?vt.groups():mt.hide(),y("Connection offline, Unable to download groups","long","bottom")):yt.error(e)})},yt.error)},yt.error)},data:function(){console.log("reading data file");var e=st.ID_Group+".json";window.requestFileSystem(o(),j,function(t){t.root.getDirectory("OSMobile/data",{create:!0},function(t){t.getFile(e,{create:!1},function(e){e.file(function(e){var t=new FileReader;t.onload=function(){if(y("Reading data from this device","short","top"),this.result.length>0){var e=JSON.parse(this.result);ot.lastUpdate=x(e.Date),Z.length=0,H.length=0;for(var t=0;t<e.Maps.length;t++)Z.push(e.Maps[t]);for(var t=0;t<e.Devices.length;t++)H.push(e.Devices[t]);g(),console.log("DrawAvalibleMaps - readfile.data"),v(),Mt.empty(),It.empty(),f(),setTimeout(function(){mt.hide()},250)}},t.readAsText(e)},yt.error)},function(e){1==e.code?1==D()?vt.maps():(mt.hide(),g(),console.log("DrawAvalibleMaps - readfile.data - else"),v(),Mt.empty(),Mt.MoveForward(),y("Connection offline, Unable to download data","long","bottom")):yt.error(e)})},yt.error)},yt.error)},changes:function(e){var t="changes.json";try{window.requestFileSystem(o(),j,function(e){e.root.getDirectory("OSMobile",{create:!0},function(e){e.getFile(t,{create:!1},function(e){e.file(function(e){var t=new FileReader;t.onload=function(){if(this.result.length>0){var e=JSON.parse(this.result);alert(e.length),K=e}else alert("No Changes")},t.readAsText(e)},yt.error)},function(e){1==e.code?(mt.hide(),console.log("No chanegs file found")):yt.error(e)})},yt.error)},yt.error)}catch(e){alert(e.toString())}},maps:function(){var e=at.Path.substr(at.Path.lastIndexOf("/")+1),t="";window.requestFileSystem(o(),j,function(r){r.root.getDirectory("OSMobile/maps",{create:!0},function(r){t=r.toURL(),r.getFile(e,{create:!1},function(e){var t=e.toURL();console.log("fileURL = "+t),a(t)},function(r){1==r.code?1==D()?(Tt.map(e,t),console.log("download.map called from ReadFile.maps")):(Dt.forceMissingMap(),console.log("ReadFile.forceMissingMap called from ReadFile.maps"),mt.hide(),y("Connection offline, Unable to download map","long","bottom")):yt.error(r)})},yt.error)},yt.error)},forceMissingMap:function(){a("missing.jpg"),mt.hide()},devImg:function(){var e=it.Image.substr(it.Image.lastIndexOf("/")+1),t="";window.requestFileSystem(o(),j,function(r){r.root.getDirectory("OSMobile/devimg",{create:!0},function(r){t=r.toURL(),r.getFile(e,{create:!1},function(e){var t=e.toURL();ht.loadImage(t)},function(r){1==r.code?1==D()?Tt.devimg(e,t):(mt.hide(),alert("Unable to download device image. Please check your connection")):yt.error(r)})},yt.error)},yt.error)}},bt={settings:function(){var e="settings.json";window.requestFileSystem(o(),j,function(t){t.root.getDirectory("OSMobile",{create:!0},function(t){t.getFile(e,{create:!1},function(e){e.remove(null,null)},null)},yt.error)},yt.error)},groups:function(){var e="groups.json";try{window.requestFileSystem(o(),j,function(t){t.root.getDirectory("OSMobile/data",{create:!0},function(t){t.getFile(e,{create:!1},function(e){e.remove(null,null)},null)},yt.error)},yt.error)}catch(t){y("error removing groups file : "+t,"long","top")}},data:function(){window.requestFileSystem(o(),j,function(e){e.root.getDirectory("OSMobile/data",{create:!0},function(e){var t=e.createReader();t.readEntries(function(e){for(var t=0;t<e.length;t++)e[t].remove()},null)},yt.error)},yt.error)},changes:function(){var e="changes.json";window.requestFileSystem(o(),j,function(t){t.root.getDirectory("OSMobile",{create:!0},function(t){t.getFile(e,{create:!1},function(e){e.remove(null,null)},null)},yt.error)},yt.error)}},yt={error:function(e){var t="";switch(e.code){case FileError.ENCODING_ERR:t="The url is malformed.";break;case FileError.INVALID_MODIFICATION_ERR:t="The modification requested is not allowed. For example, the app might be trying to move a directory into its own child or moving a file into its parent directory without changing its name";break;case FileError.INVALID_STATE_ERR:t="The operation cannot be performed on the current state of the interface object.";break;case FileError.NO_MODIFICATION_ALLOWED_ERR:t="The state of the underlying file system prevents any writing to a file or a directory.";break;case FileError.NOT_FOUND_ERR:t="A required file or directory could not be found.";break;case FileError.NOT_READABLE_ERR:t="The file or directory cannot be read, typically due to permission problems that occur after a reference to a file has been acquired.";break;case FileError.PATH_EXISTS_ERR:t="The file or directory with the same path already exists.";break;case FileError.QUOTA_EXCEEDED_ERR:t="Either there's not enough remaining storage space or the storage quota was reached or the user declined to give more space to the database.";break;case FileError.SECURITY_ERR:t="SECURITY_ERR ";break;case FileError.TYPE_MISMATCH_ERR:t="The app looked up an entry,but the entry found is of the wrong type.For example, the app is asking for a directory, when the entry is really a file.";break;default:t="Unknown Error "}alert(t+" "+e.code),console.log(t+" "+e.code)}},At={MoveForward:function(t){if(0==e("#GroupsMasterGroup").children().length)console.log("Create Root"),At.RootGroup();else{var r=!1,o=null;e.each(e("#GroupsMasterGroup>panel.group").children(),function(n,a){e(a).attr("child")==t&&(r=!0,o=e(a))}),0==r?(console.log("Create SubGroup"),At.CreateSubGroup(t)):setTimeout(function(){e("#GroupsMasterGroup>panel.group").children("[open]").removeAttr("open").attr("left",""),o.removeAttr("right").attr("open",""),e("#GroupsMasterGroup").parent().next().removeAttr("novis"),mt.hide()},10)}},RootGroup:function(){e("#GroupsMasterGroup").empty();var t="";t+="<panel class='group'>";var r=z[0],o="hasKids";0==At.CheckForChildren(r)&&(o+=" hide"),t+="<panel open class='child' root><scroll class='y'><row class='content'>",t+="<row class='item' groupid='"+r.ID_Group+"' fullpath='"+r.FullPath+"' groupPath='"+r.GroupPath+"'' ><span><name>"+r.ID_Group+" - "+r.Name+"</name></span><a class='button "+o+" ' href='#'></a><a class='button isselected' href='#'></a></row>",t+="</row></scroll></panel></panel>",e("#GroupsMasterGroup").append(t),e("#GroupsMasterGroup").parent().next().attr("novis",""),mt.hide()},CreateSubGroup:function(t){var r=e("#GroupsMasterGroup>panel.group"),o="";o+="<panel right class='child' child='"+t+"' ><scroll class='y'><row class='content'>";for(var n=new Array,a=z.slice(0),i=1;i<a.length;i++)a[i].FullPath==t+""+a[i].ID_Group+"."&&n.push(a[i]);for(var i=0;i<n.length;i++){var s="haskids";0==At.CheckForChildren(n[i])&&(s+=" hide"),o+="<row class='item' groupid='"+n[i].ID_Group+"' fullpath='"+n[i].FullPath+"' groupPath='"+n[i].GroupPath+"'' ><span><name>"+n[i].ID_Group+" - "+n[i].Name+"</name></span><a class='button "+s+" ' href='#'></a><a class='button isselected' href='#'></a></row>"}o+="</row></scroll></panel>",e(r).append(o),setTimeout(function(){e(r).children("[open]").removeAttr("open").attr("left",""),e(r).children(":last-child").removeAttr("right").attr("open",""),e("#GroupsMasterGroup").parent().next().removeAttr("novis"),mt.hide()},10)},CheckForChildren:function(e){for(var t=0,r=z.slice(0),o=0;o<r.length;o++)r[o].GroupPath==e.GroupPath+"."+e.ID_Group&&t++;return t}},Mt={current:0,RootGroup:function(){e("#DevicesonMapGroup").empty();var t="";t+="<panel class='group'>",t+="<panel open class='child '><scroll class='y'><row class='content'>";for(var r=0;r<lt[0].length;r++){var o=lt[0][r].ID_Device,n=lt[0][r].Description,a=lt[0][r].SerialNumber;0==n.length&&(n="No Description"),0==a.length&&(a="No Serial Number"),t+="<row class='button item mDevice' id='"+o+"'><span><name>"+n+"</name><serial>"+a+"</serial></span></row>"}t+="</row></scroll></panel>",t+="</panel>",t+='<row class="master" style="-webkit-box-flex: 1; min-height: 40px;max-height: 40px;"><row class="back"><a href="#" class="button backward" id="btnBackwards_On"></a><indicator>0</indicator><a href="#" class="button forward" id="btnforwards_On"></a></row></row>',e("#DevicesonMapGroup").empty().append(t),t.length=0,Mt.current=0,mt.hide()},NextGroup:function(){var t="";t+="<panel right class='child '><scroll class='y'><row class='content'>",console.log(Mt.current);for(var r=0;r<Mt[Mt.current].length;r++){var o=Mt[Mt.current][r].ID_Device,n=Mt[Mt.current][r].Description,a=Mt[Mt.current][r].SerialNumber;0==n.length&&(n="No Description"),0==a.length&&(a="No Serial Number"),t+="<row class='button item mDevice' id='"+o+"'><span><name>"+n+"</name><serial>"+a+"</serial></span></row>"}t+="</row></scroll></panel>",e("#DevicesonMapGroup>panel.group").append(t),e("#DevicesonMapGroup>panel.group>panel.child").attr("left","").removeAttr("open").removeAttr("right"),e("#DevicesonMapGroup>panel.group>panel.child:last-child").attr("open","").removeAttr("left").removeAttr("right"),setTimeout(function(){e("#DevicesonMapGroup>panel.group>panel.child:first-child").remove()},700),t.length=0,mt.hide()},PrevGroup:function(){var t="";t+="<panel left class='child '><scroll class='y'><row class='content'>",console.log(Mt.current);for(var r=0;r<Mt[Mt.current].length;r++){var o=Mt[Mt.current][r].ID_Device,n=Mt[Mt.current][r].Description,a=Mt[Mt.current][r].SerialNumber;0==n.length&&(n="No Description"),0==a.length&&(a="No Serial Number"),t+="<row class='button item mDevice' id='"+o+"'><span><name>"+n+"</name><serial>"+a+"</serial></span></row>"}t+="</row></scroll></panel>",e("#DevicesonMapGroup>panel.group").append(t),e("#DevicesonMapGroup>panel.group>panel.child").attr("right","").removeAttr("open").removeAttr("left"),e("#DevicesonMapGroup>panel.group>panel.child:last-child").attr("open","").removeAttr("left").removeAttr("right"),setTimeout(function(){e("#DevicesonMapGroup>panel.group>panel.child:first-child").remove()},700),t.length=0,mt.hide()},empty:function(){Mt.current=-1;var t="";t+="<row class='item none' id='none'><span><name>No Devices</name><serial>This map has no devices</serial></span></row>",console.log("Drawing"),e("#DevicesonMapGroup").empty().append(t),t.length=0,mt.hide()},MoveForward:function(){lt.length>0?-1==Mt.current?(mt.hide(),mt.show(),Mt.RootGroup()):(Mt.current++,Mt.current<lt.length?(mt.hide(),mt.show(),Mt.NextGroup(),e("a.button#btnforwards_On").prev("indicator").html(It.current)):Mt.current--):Mt.empty()},MoveBackward:function(){Mt.curernt--,Mt.current<0?Mt.current=0:(mt.hide(),mt.show(),Mt.PrevGroup(),e("a.button#btnforwards_On").prev("indicator").html(It.current))}},It={current:0,RootGroup:function(){var t="";t+="<panel class='group'>",t+="<panel open class='child '><scroll class='y'><row class='content'>";for(var r=0;r<ct[0].length;r++){var o=ct[0][r].ID_Device,n=ct[0][r].Description,a=ct[0][r].SerialNumber;0==n.length&&(n="No Description"),0==a.length&&(a="No Serial Number"),t+="<row class='button item uDevice' id='"+o+"'><span><name>"+n+"</name><serial>"+a+"</serial></span></row>"}t+="</row></scroll></panel>",t+="</panel>",t+='<row class="master" style="-webkit-box-flex: 1; min-height: 40px;max-height: 40px;"><row class="back"><a href="#" class="button backward" id="btnBackwards_Off"></a><indicator>0</indicator><a href="#" class="button forward" id="btnforwards_Off"></a></row></row>',e("#MissingDevicesGroups").empty().append(t),t.length=0,It.current=0,mt.hide()
},NextGroup:function(){var t="";t+="<panel right class='child '><scroll class='y'><row class='content'>",console.log(It.current);for(var r=0;r<ct[It.current].length;r++){var o=ct[It.current][r].ID_Device,n=ct[It.current][r].Description,a=ct[It.current][r].SerialNumber;0==n.length&&(n="No Description"),0==a.length&&(a="No Serial Number"),t+="<row class='button item uDevice' id='"+o+"'><span><name>"+n+"</name><serial>"+a+"</serial></span></row>"}t+="</row></scroll></panel>",e("#MissingDevicesGroups>panel.group").append(t),e("#MissingDevicesGroups>panel.group>panel.child").attr("left","").removeAttr("open").removeAttr("right"),e("#MissingDevicesGroups>panel.group>panel.child:last-child").attr("open","").removeAttr("left").removeAttr("right"),setTimeout(function(){e("#MissingDevicesGroups>panel.group>panel.child:first-child").remove()},700),t.length=0,mt.hide()},PrevGroup:function(){var t="";t+="<panel left class='child '><scroll class='y'><row class='content'>",console.log(It.current);for(var r=0;r<ct[It.current].length;r++){var o=ct[It.current][r].ID_Device,n=ct[It.current][r].Description,a=ct[It.current][r].SerialNumber;0==n.length&&(n="No Description"),0==a.length&&(a="No Serial Number"),t+="<row class='button item uDevice' id='"+o+"'><span><name>"+n+"</name><serial>"+a+"</serial></span></row>"}t+="</row></scroll></panel>",e("#MissingDevicesGroups>panel.group").append(t),e("#MissingDevicesGroups>panel.group>panel.child").attr("right","").removeAttr("open").removeAttr("left"),e("#MissingDevicesGroups>panel.group>panel.child:last-child").attr("open","").removeAttr("left").removeAttr("right"),setTimeout(function(){e("#MissingDevicesGroups>panel.group>panel.child:first-child").remove()},700),t.length=0,mt.hide()},empty:function(){It.current=-1;var t="";t+="<row class='item none' id='none'><span><name>No Devices</name><serial>This map has no devices</serial></span></row>",e("#MissingDevicesGroups").empty().append(t),t.length=0,mt.hide()},MoveForward:function(){ct.length>0?-1==It.current?(mt.hide(),mt.show(),It.RootGroup()):(It.current++,It.current<ct.length?(mt.hide(),mt.show(),It.NextGroup(),e("a.button#btnforwards_Off").prev("indicator").html(It.current)):It.current--):It.empty()},MoveBackward:function(){It.current--,It.current<0?It.current=0:(mt.hide(),mt.show(),It.PrevGroup(),e("a.button#btnforwards_Off").prev("indicator").html(It.current))}},Tt={map:function(e,t){console.log("map function entered");var r=new FileTransfer,o=encodeURI(Y+"/Maps/"+e),n=t+"/"+e;r.download(o,n,function(e){console.log("entry = "),console.log(e),Dt.maps(),console.log("ReadFile.maps first call"),mt.hide()},function(e){switch(e.code){case FileTransferError.FILE_NOT_FOUND_ERR:y("Cannot find Map Image","long","bottom"),setTimeout(function(){Dt.forceMissingMap()},1);break;case FileTransferError.INVALID_URL_ERR:alert("Server URL is incorrect.");break;case FileTransferError.CONNECTION_ERR:y("Cannot find connection path for Map Image","long","bottom"),setTimeout(function(){Dt.forceMissingMap()},1);break;case FileTransferError.ABORT_ERR:msg+="Process was aborted.",mt.hide()}},!0,{headers:{Authorization:"Basic dGVzdHVzZXJuYW1lOnRlc3RwYXNzd29yZA=="}})},devimg:function(e,t){var r=new FileTransfer,o=encodeURI(Y+"/devimg/"+e),n=t+"/"+e;r.download(o,n,function(e){var t=e.toURL();ht.loadImage(t)},Tt.error,!0,{headers:{Authorization:"Basic dGVzdHVzZXJuYW1lOnRlc3RwYXNzd29yZA=="}})},error:function(e){var t="";switch(e.code){case FileTransferError.FILE_NOT_FOUND_ERR:t+="File cannot be found.";break;case FileTransferError.INVALID_URL_ERR:t+="Server URL is incorrect.";break;case FileTransferError.CONNECTION_ERR:t+="Cannot find connection path for Image download";break;case FileTransferError.ABORT_ERR:t+="Process was aborted."}alert(t),mt.hide()}},St={ready:function(){0==E.Browser&&navigator.splashscreen.show(),L.online=!0,L.status="online",pt.hide(),M(),g(),console.log("DrawAvalibleMaps - PhoneGap.ready"),v(),Mt.empty(),It.empty(),f(),w(),L.type=1==E.Browser?"WiFi":navigator.connection.type,e("#deleteoptions").attr("novis",""),e("#deleteoptions").prev().removeAttr("novis"),B&&(e("#inputUsername").val("admin"),e("#inputPassword").val("admin")),Dt.settings()},back:function(){e("#login").hasClass("visible")?navigator.app.exitApp():G("Do you want exit the app?",function(e){1==e&&navigator.app.exitApp()},"Exit App",["Exit","Cancel"])},pause:function(){navigator.splashscreen.hide()},resume:function(){navigator.splashscreen.hide()},online:function(){L.online=!0,L.status="online",L.type=navigator.connection.type,y("Device online","short","bottom"),e("#NetStatus").addClass("online").removeClass("offline"),1==ot.logged&&1==ot.changes&&G("Changes have been detected",function(t){1==t&&(Dt.changes(),mt.show(),setTimeout(function(){vt.changes()},250)),2==t&&(K.length=0,bt.changes(),e("#btnDownload").trigger("tap"))},"Changes detected",["Upload","Ignore"])},offline:function(){L.online=!1,L.status="offline",L.type=navigator.connection.type,y("Device offline","short","bottom")}};document.addEventListener("deviceready",St.ready,!1),document.addEventListener("backbutton",St.back,!1),document.addEventListener("pause",St.pause,!1),document.addEventListener("resume",St.resume,!1),document.addEventListener("online",St.online,!1),document.addEventListener("offline",St.offline,!1);var Ft={preventMouse:!0,transformMinScale:1.1};e("#btnLogbook").hammer(Ft).on("tap",function(){console.log("hizsdbgfhsdfhidbh"),pt.show(),e("#logbook").removeAttr("novis")}),e("#btnTogPanel").hammer(Ft).on("tap",function(t){t.preventDefault(),0==tt&&(tt=!0,e(this).parents("page").find("content>panel.master").toggleClass("out").toggleClass("in"),e("map>viewport").attr("novis",""),c(),setTimeout(function(){e("map>viewport").removeAttr("novis"),l()},100),setTimeout(function(){tt=!1},1e3))}),e("#btnLogin").hammer(Ft).on("tap",function(){if(""==e("#inputUsername").val()||""==e("#inputPassword").val())y("Username or password is blank","long","top");else if(mt.show(),1==D()){var t=e("#inputUsername").val(),o=e("#inputPassword").val();setTimeout(function(){r(t,o)},125)}else mt.hide(),console.log("server address = "+Y),y("Connection is offline","long","top")}),e("#btnSettings").hammer(Ft).on("tap",function(){dt.show(),gt.hide(),ut.hide(),e("#inputServerAddress").val(Y)}),e("#btnViewLogin").hammer(Ft).on("tap",function(){dt.hide(),ut.show()}),e("#btnSaveServerAddress").hammer(Ft).on("tap",function(){""==e("#inputServerAddress").val()?y("Server Address is blank","long","top"):(t(e("#inputServerAddress").val()),y("server ip set to = "+Y,"long","top"))}),e("#btnClearData").hammer(Ft).on("tap",function(){try{localStorage.clear(),bt.groups(),y("Local Storage Cleared","long","top")}catch(e){y("Error Clearing Local Storage : "+e,"long","top")}}),e("#btnDeviceComments").hammer(Ft).on("tap",function(){e("#DeviceComments").removeAttr("novis")}),e("#btnSaveDeviceComments").hammer(Ft).on("tap",function(){e("#DeviceComments").attr("novis"),C(e("#DeviceComments textarea").val)}),e("#btnContinue").hammer(Ft).on("tap",function(){1==ot.logged?(y("Loading Groups","short","top"),mt.show(),1==D()?(ut.hide(),dt.hide(),vt.groups()):(ut.hide(),Dt.groups())):y("No previous user","short","center")}),e("#btnDownload").hammer(Ft).on("tap",function(){e("#MapTitle").empty().html("OneStop"),1==D()?(e("#MapsMasterPanel").removeAttr("left").removeAttr("right").attr("open",""),e("#DevicesOnMapPanel").removeAttr("open").removeAttr("left").removeAttr("right").attr("left",""),e("#MissingDevicesPanel").removeAttr("open").removeAttr("left").removeAttr("right").attr("right",""),e("#InformationPanel").removeAttr("open").removeAttr("left").removeAttr("right").attr("left",""),e("map>viewport>pog.selecteddevice").removeClass("selecteddevice"),e("#MapsMasterPanel").removeAttr("right").attr("open",""),p(),c(),mt.show(),at=0,it=0,Z.length=0,H.length=0,K.length=0,Q.length=0,e("li.button.remove").removeClass("remove"),e("#deleteoptions").attr("novis",""),e("#deleteoptions").prev().removeAttr("novis"),vt.maps()):(mt.hide(),y("Device offline. Unable to download data","long","center"))}),e("#btnBin").hammer(Ft).on("tap",function(){if(Q.length>0){y("Deleting devices - Remeber to save","short","top"),mt.show();for(var t=0;t<Q.length;t++){for(var r=0;r<H.length;r++)H[r].ID_Device==Q[t]&&(H[r].ID_Map=0,H[r].Image="devimg/default.png",H[r].Locked=!1,H[r].X=0,H[r].Y=0);F(Q[t])}wt.data(),lt.length=0,ct.length=0;for(var t=0;t<H.length;t++)H[t].ID_Map==at.ID_Map&&lt.push(H[t]),0==H[t].ID_Map&&ct.push(H[t]);lt=d(lt),ct=d(ct),Mt.empty(),It.empty(),m(),h(),setTimeout(function(){Mt.MoveForward()},100),s(),e("#deleteoptions").attr("novis",""),e("#deleteoptions").prev().removeAttr("novis"),e("#btnBinSelected").html(" 0 "),Q.length=0}else y("Nothing to delete","short","top")}),e("map>viewport>img").hammer(Ft).on("touch",function(){e("map>viewport>.selecteddevice").removeClass("selecteddevice")}),e("#btnSave").hammer(Ft).on("tap",function(){if(K.length>0)if(1==D())mt.show(),setTimeout(function(){vt.changes()},100);else{mt.show();for(var e=new Array,t=0;t<K.length;t++)e.push(K[t]);K.length=0;var r="changes.json";try{window.requestFileSystem(o(),j,function(t){t.root.getDirectory("OSMobile",{create:!0},function(t){t.getFile(r,{create:!1},function(t){t.file(function(t){var r=new FileReader;r.onload=function(){if(this.result.length>0){var t=JSON.parse(this.result);K=t,K.splice(K.length-1,1);for(var r=0;r<e.length;r++)K.push(e[r]);ot.changes=1,wt.settings(),wt.changes(),wt.data(),setTimeout(function(){mt.hide(),y("Changes saved local","short","top")},100)}else alert("No Changes")},r.readAsText(t)},yt.error)},function(t){if(1==t.code){for(var r=0;r<e.length;r++)K.push(e[r]);ot.changes=1,wt.settings(),wt.changes(),wt.data(),setTimeout(function(){mt.hide(),y("Changes saved local","short","top")},100)}else yt.error(t)})},yt.error)},yt.error)}catch(n){alert(n.toString())}}else y("0 changes have been made","short","top")});var kt=!1;e(window).hammer(Ft).on("tap","a.button.back#btnBack",function(){if(0==kt){if(kt=!0,"MissingDevicesPanel"==e(this).parents("panel.child").attr("id")&&(e("#MissingDevicesPanel").removeAttr("open").attr("right",""),e("#DevicesOnMapPanel").removeAttr("left").removeAttr("right").attr("open")),"InformationPanel"==e(this).parents("panel.child").attr("id")){if(e("#InformationPanel").removeAttr("open").attr("left",""),1==rt){e("#DevicesOnMapPanel").removeAttr("right").removeAttr("left").attr("open",""),e("#MissingDevicesPanel").removeAttr("right").removeAttr("left").removeAttr("open").attr("right",""),lt.length=0;for(var t=0;t<H.length;t++)H[t].ID_Map==at.ID_Map&&lt.push(H[t]);lt=d(lt),Mt.empty(),m(),setTimeout(function(){Mt.MoveForward()},100),rt=!0}else e("#DevicesOnMapPanel").removeAttr("right").removeAttr("left").attr("open",""),e("#MissingDevicesPanel").removeAttr("right").removeAttr("left").removeAttr("open").attr("right","");if(1==DeviceAdd){e("#MissingDevicesPanel").removeAttr("right").removeAttr("left").attr("open",""),lt.length=0,ct.length=0;for(var t=0;t<H.length;t++)H[t].ID_Map==at.ID_Map&&lt.push(H[t]),0==H[t].ID_Map&&ct.push(H[t]);lt=d(lt),ct=d(ct),Mt.empty(),It.empty(),m(),h(),setTimeout(function(){Mt.MoveForward(),It.MoveForward()},100),DeviceAdd=!0}else e("#DevicesOnMapPanel").removeAttr("right").removeAttr("left").attr("open",""),e("#MissingDevicesPanel").removeAttr("right").removeAttr("left").removeAttr("open").attr("right","")}if("DevicesOnMapPanel"==e(this).parents("panel.child").attr("id")&&(e("#DevicesOnMapPanel").removeAttr("open").attr("left",""),e("#MapsMasterPanel").removeAttr("right").removeAttr("left").attr("open","")),"GroupSelect"==e(this).parents("float.master").attr("id")){var r=e(this).parents("row.master").prev().find("panel[open]");null!=r.prev().attr("root")&&e("#GroupsMasterGroup").parent().next().attr("novis",""),e.each(e("#GroupsMasterGroup>panel.group").find("row.item"),function(t,o){e(o).attr("fullpath")==r.attr("child")&&(r.removeAttr("open").attr("right",""),e(o).parents("panel.child").removeAttr("left").removeAttr("right").attr("open",""))})}e("map>viewport>pog.selecteddevice").removeClass("selecteddevice")}setTimeout(function(){kt=!1},700)}),e("#btnExit").hammer(Ft).on("tap",function(){navigator.app.exitApp()});var Nt=!1;e(window).hammer(Ft).on("tap",".map",function(){if(0==Nt){Nt=!0;var t=e(this).attr("id");if(e("li.button.remove").removeClass("remove"),Q.length=0,e("#deleteoptions").attr("novis",""),e("#deleteoptions").prev().removeAttr("novis"),at.ID_Map==t)setTimeout(function(){e("#MapsMasterPanel").removeAttr("open").attr("right",""),e("#DevicesOnMapPanel").removeAttr("left").attr("open",""),mt.hide()},1);else{mt.show(),p();for(var r=0;r<Z.length;r++)Z[r].ID_Map==t&&(at=Z[r]);w(),setTimeout(function(){lt.length=0,ct.length=0;for(var e=0;e<H.length;e++)H[e].ID_Map==at.ID_Map&&lt.push(H[e]),0==H[e].ID_Map&&ct.push(H[e]);lt=d(lt),ct=d(ct),Mt.empty(),It.empty(),m(),h(),setTimeout(function(){Mt.MoveForward()},100)},100),Dt.maps(),console.log("ReadFile.maps second call")}}setTimeout(function(){Nt=!1},200)});var xt={preventDefault:!0,preventMouse:!0},Gt={event:null,target:null,dist:0,maxdist:0,scrolling:!1,scrolltimeout:!1,dragging:!1},_t=null;e("scroll.y").hammer(Ft).on("scroll",function(t){t.preventDefault(),0==Gt.dragging?(e(Gt.target).css("-webkit-transform",""),Gt.event=null,Gt.target=null,clearTimeout(_t),Gt.scrolltimeout=!0,_t=setTimeout(function(){console.log("Timeout Scrolling"),Gt.scrolltimeout=!1},500)):(t.preventDefault(),t.gesture.stopDetect())}),e(window).hammer(xt).on("tap dragright dragup dragdown release",".mDevice",function(t){switch(t.type){case"tap":t.stopPropagation(),t.preventDefault();var r=e(this).attr("id");it=k(r),e.each(e("map>viewport>pog"),function(t,r){e(r).attr("id")==it.ID_Device&&e(r).addClass("selecteddevice")}),setTimeout(function(){e("#DevicesOnMapPanel").removeAttr("open").attr("right",""),e("#MissingDevicesPanel").removeAttr("open").attr("right",""),e("#InformationPanel").removeAttr("left").attr("open","")},10),I();break;case"dragright":0==Gt.scrolltimeout&&0==Gt.scrolltimeout&&(Gt.dragging=!0,Gt.event="dragright",Gt.target=e(this),Gt.maxdist=parseFloat(e(Gt.target).width())/2/2,t.gesture.distance=Math.min(Gt.maxdist,t.gesture.distance),e(Gt.target).css("-webkit-transform","translate3d("+t.gesture.distance+"px,0px,0px)"),e(Gt.target).parents("scroll").attr("scroll",e(Gt.target).parents("scroll").scrollTop()),Gt.dist=t.gesture.distance);break;case"release":if(0==Gt.scrolltimeout&&0==Gt.scrolltimeout){if(Gt.dist==Gt.maxdist&&"dragright"==Gt.event){if(e(Gt.target).hasClass("remove")){for(var o=0;o<Q.length;o++)Q[o]==e(Gt.target).attr("id")&&(Q.splice(o,1),e("#btnBinSelected").html(Q.length+" selected"));try{e.each(e("map>viewport>pog"),function(t,r){e(r).attr("id")==e(Gt.target).attr("id")&&e(r).removeClass("togDelete")})}catch(t){alert(t.toString()+" adding errror")}e(Gt.target).removeClass("remove")}else{try{e.each(e("map>viewport>pog"),function(t,r){e(r).attr("id")==e(Gt.target).attr("id")&&e(r).addClass("togDelete")})}catch(t){alert(t.toString()+" removal errror")}Q.push(e(Gt.target).attr("id")),e("#btnBinSelected").html(Q.length+" selected"),e(Gt.target).addClass("remove")}Q.length>0?(e("#deleteoptions").removeAttr("novis"),e("#deleteoptions").prev().attr("novis","")):(e("#deleteoptions").attr("novis",""),e("#deleteoptions").prev().removeAttr("novis")),e(Gt.target).css("-webkit-transform",""),e(Gt.target).parents("scroll").scrollTop(e(Gt.target).parents("scroll").attr("scroll")),Gt.target=null,Gt.event=null,Gt.dist=0,Gt.maxdist=0}else e(Gt.target).css("-webkit-transform",""),Gt.target=null;Gt.dragging=!1}}}),e(window).hammer(xt).on("tap drag dragright release",".uDevice",function(t){switch(t.type){case"drag":0==Gt.scrolltimeout&&(t.gesture.center.pageX>e(this).parents("panel.master").width()?(e("#ulFloat").removeAttr("novis"),e("#ulFloat").css({left:t.gesture.center.pageX,top:t.gesture.center.pageY})):(e("#ulFloat").attr("novis",""),e("#ulFloat").css({left:0,top:0})));break;case"dragright":if(0==Gt.scrolltimeout&&0==Gt.scrolltimeout){null==Gt.target&&(Gt.target=e(this)),e(Gt.target).parents("scroll").attr("scroll",e(Gt.target).parents("scroll").scrollTop());var r=t.gesture.center.pageX-e(Gt.target).width()/2/2;e(Gt.target).css({"-webkit-transform":"translate3d("+r+"px,"+0+"px,0px)"}),e(Gt.target).parents("scroll").css("overflow-y","hidden"),e(Gt.target).parents("scroll").scrollTop(e(Gt.target).parents("scroll").attr("scroll"))}break;case"release":if(0==Gt.scrolltimeout&&0==Gt.scrolltimeout){e(Gt.target).css({"-webkit-transform":""}),e(Gt.target).parents("scroll").css("overflow-y","auto"),e(Gt.target).parents("scroll").scrollTop(e(Gt.target).parents("scroll").attr("scroll"));var r=t.gesture.center.pageX,o=t.gesture.center.pageY,n=document.elementFromPoint(r,o);"IMG"==n.nodeName||"POG"==n.nodeName?(e("#ulFloat").attr("value",e(Gt.target).attr("id")),Q.length=0,e("#deleteoptions").attr("novis",""),e("#deleteoptions").prev().removeAttr("novis"),e("#btnBinSelected").html(" 0 "),i(r,o),e("#ulFloat").attr("novis",""),e("#ulFloat").css({left:"",top:""}),e("#ulFloat").attr("value",null)):(e("#ulFloat").attr("novis",""),e("#ulFloat").css({left:"",top:""}),e("#ulFloat").attr("value",null)),Gt.target=null}}}),e(window).hammer(Ft).on("tap","map>viewport>pog",function(){e("map>viewport>pog.selecteddevice").removeClass("selecteddevice");var t=k(e(this).attr("id"));it=t,e(this).addClass("selecteddevice"),setTimeout(function(){e("#DevicesOnMapPanel").removeAttr("open").attr("right",""),e("#InformationPanel").removeAttr("left").attr("open",""),e("#MissingDevicesPanel").removeAttr("open").attr("right","")},10),I()});var Ot={startObj:null,delta:{x:0,y:0},dtObj:null,doubletap:!1};e(document.body).hammer().on("dragstart drag dragend","map>viewport>pog.unlocked",function(t){switch(e("map>viewport>pog.selecteddevice").removeClass("selecteddevice"),t.type){case"dragstart":var r=k(e(this).attr("id"));it=r,I(),Ot.startObj=e(this);break;case"drag":var o=e("map").position(),n={w:e("map>viewport>img").width(),h:e("map>viewport>img").height()},a=e("map>viewport>img").attr("offset").split(" ")[0],i=e("map>viewport>img").attr("offset").split(" ")[1],s=10,l=parseFloat(n.w)-2*s,c=parseFloat(n.h)-s;Ot.delta.x=t.gesture.center.pageX-parseFloat(o.left)-parseFloat(a),Ot.delta.y=t.gesture.center.pageY-parseFloat(o.top)-parseFloat(i),Ot.delta.x=Math.max(s,Ot.delta.x),Ot.delta.y=Math.max(s,Ot.delta.y),Ot.delta.x=Math.min(l,Ot.delta.x),Ot.delta.y=Math.min(c,Ot.delta.y);var p="",u="1,0,0,-1",d="1,0, 0, 1",t="0,-1, 1, 0",g="0, 1, -1, 0";p=d,Ot.delta.x<70&&(p=g),Ot.delta.x>parseFloat(n.w)-70&&(p=t),Ot.delta.y<70&&(p=u),e(Ot.startObj).css({"-webkit-transform":"matrix("+p+","+Ot.delta.x+","+Ot.delta.y+")"});for(var m=0;m<H.length;m++)H[m].ID_Device==e(Ot.startObj).attr("id")&&(H[m].X=Ot.delta.x/parseFloat(e("map>viewport>img").width())*q,H[m].Y=Ot.delta.y/parseFloat(e("map>viewport>img").height())*J,it.ID_Device==H[m].ID_Device&&e("#infoDevicePosition").val(H[m].X.toFixed(0)+" : "+H[m].Y.toFixed(0)));break;case"dragend":console.log("Drag end");var h=e(Ot.startObj).css("-webkit-transform");h=h.substr(h.lastIndexOf("(")).replace(/\(|\)/g,"").split(", ");var v=parseFloat(h[4]),f=parseFloat(h[5]);v=v/parseFloat(e("map>viewport>img").width())*q,f=f/parseFloat(e("map>viewport>img").height())*J;for(var m=0;m<H.length;m++)H[m].ID_Device==e(Ot.startObj).attr("id")&&(H[m].X=v,H[m].Y=f,T(H[m].ID_Device,"position",H[m].X.toFixed(0)+" "+H[m].Y.toFixed(0)),it.ID_Device==H[m].ID_Device&&e("#infoDevicePosition").val(H[m].X.toFixed(0)+" : "+H[m].Y.toFixed(0)));Ot.startObj=null}}),e("map>viewport").hammer(Ft).on("transformstart transform transformend",function(t){switch(t.preventDefault(),t.type){case"transformstart":U.start=t.gesture.center;break;case"transform":U.scale=Math.max(1,t.gesture.scale*U.oldScale),U.scale=Math.min(5,U.scale),U.matrix=e(this).css("-webkit-transform").replace(/(matrix)|([\()])/g," ").split(","),e(this).css("-webkit-transform","matrix("+U.scale+",0,0,"+U.scale+",0,0)");break;case"transformend":U.oldScale=U.scale,U.end=t.gesture.center}}),e("#inputselectGroup").parent().hammer(Ft).on("tap",function(){e("#MapTitle").empty().html("OneStop"),null!=e("float#GroupSelect").attr("novis")&&(pt.show(),setTimeout(function(){p(),c(),nt=!1,at=new Object,it=new Object,ct.length=0,lt.length=0,e("float#GroupSelect").removeAttr("novis")},10))}),e(window).hammer(Ft).on("tap","a.button.close",function(){pt.hide(),e(this).parents("float.master").attr("novis",""),"logbook"==e(this).parents("float.master").attr("id")&&e("#logbookLog").children(".master").removeClass("expand").removeClass("collapse").addClass("expand"),setTimeout(function(){},10)});var Ct=!1;e(window).hammer(Ft).on("tap","a.button.hasKids",function(){if(mt.show(),0==Ct){var t=e(this).parent().attr("fullPath");At.MoveForward(t),Ct=!0}setTimeout(function(){Ct=!1},700)}),e(window).hammer(Ft).on("tap",".isselected",function(){console.log("HAMMER TIME!"),console.log(this);var t=e(this).parent().attr("groupid");if(0==Ct){for(var r=0;r<z.length;r++)z[r].ID_Group==t&&(A(r),console.log("changeGroup called from event"));Ct=!0,setTimeout(function(){e("float#GroupSelect").attr("novis",""),pt.hide()},100)}setTimeout(function(){Ct=!1},700)}),e("#btnExtSelectCancel").hammer(Ft).on("tap",function(){try{ExtSelect.hide()}catch(e){console.log(e)}}),e("panel[right]>swipe").hammer(Ft).on("tap dragright swiperight dragleft swipeleft",function(t){e("#btnTogPanel").trigger("tap"),t.stopPropagation(),t.preventDefault(),t.gesture.stopDetect()}),e("#btnDeviceImageClose").hammer(Ft).on("tap",function(){e(this).parents("display.master").attr("novis","")}),e("#btnDeviceImage").hammer(Ft).on("tap",function(){pt.show(),ht.show(),Dt.devImg()}),e("#btnUsePhoto").hammer(Ft).on("tap",function(){ht.hide(),ht.ClearImage(),setTimeout(function(){ft.getCameraroll()},10)}),e("#btnNewPhoto").hammer(Ft).on("tap",function(){ht.hide(),ht.ClearImage(),setTimeout(function(){ft.getPicture()},10)}),e("row.item>label.text").hammer(Ft).on("tap",function(){console.log(" working ");var t=e(this).children("input").attr("id"),r=["Ok","Cancel"];switch(console.log(t),t){case"infoDeviceAssetNumber":_("Give the device a new Asset Number",function(e){1==e.buttonIndex&&b(e.input1,"assetnumber")},"Asset Number",r,it.AssetNumber);break;case"infoDeviceDescription":_("Give the device a new description",function(e){1==e.buttonIndex&&b(e.input1,"description")},"Device Description",r,it.Description);break;case"infoDeviceLocation":_("Change location",function(e){1==e.buttonIndex&&b(e.input1,"location")},"Device Location",r,it.Location);break;case"infoDeviceSerialNumber":_("Change the serial number",function(e){1==e.buttonIndex&&b(e.input1,"serialnumber")},"Serial Number",r,it.SerialNumber);break;case"infoDevicePosition":return 0}}),e("a.button.locate").hammer(Ft).on("tap",function(){e.each(e("map>viewport>pog"),function(t,r){e(r).attr("id")==it.ID_Device&&e(r).addClass("selecteddevice")})}),e("#infoDeviceLock").hammer(Ft).on("change",function(){b(e("#infoDeviceLock").prop("checked"),"locked")}),e(window).hammer(Ft).on("tap","dropdown.head",function(){e(this).parent().toggleClass("expand").toggleClass("collapse"),e(this).next().children().removeClass("collapse").addClass("expand")}),e("#btnClearLog").hammer(Ft).on("tap",function(){e("#logbookLog").empty()}),e("#inputUsername, #inputPassword").on("focus blur",function(t){"focus"==t.type&&e(this).focus(),e(this).parents("div").css({"margin-bottom":"50%"}),"blur"==t.type&&e(this).parents("div").css({"margin-bottom":"0%"})}),e("#btnAddDevices").hammer(Ft).on("tap",function(){$||($=!0,e(this).parents("panel.child").removeAttr("left").attr("left",""),e("#MissingDevicesPanel").removeAttr("right").attr("open",""),It.empty(),mt.show(),h(),setTimeout(function(){It.MoveForward()},500),setTimeout(function(){$=!1},700))}),e("#btnSearch").hammer(Ft).on("tap",function(){null!=e("#GroupSearch").attr("novis")?(e("#GroupSearch").removeAttr("novis"),setTimeout(function(){e(".autoComplete").trigger("tap")},100)):e("#GroupSearch").attr("novis","")}),e("#btnTest").hammer(Ft).on("tap",function(){vt.groups()}),e("shadow").hammer(Ft).on("touch release",function(){e("float#GroupSelect").attr("novis")||e("float#GroupSelect").attr("novis",""),e("#logbook").attr("novis")||(e("#logbook").attr("novis",""),e("#logbookLog").children(".master").removeClass("expand").removeClass("collapse").addClass("expand")),e("#DeviceImageDisplay").attr("novis")||ht.hide(),pt.hide()}),e(window).hammer(Ft).on("tap","a.button#btnforwards_Off",function(){It.MoveForward()}),e(window).hammer(Ft).on("tap","a.button#btnbackwards_Off",function(){It.MoveBackward()}),e(window).hammer(Ft).on("tap","a.button#btnforwards_On",function(){Mt.MoveForward()}),e(window).hammer(Ft).on("tap","a.button#btnbackwards_On",function(){Mt.MoveBackward()}),e(window).hammer(Ft).on("tap","a.button#btnforwards",function(){var t=e(this).prev("indicator"),r=parseInt(t.html()),o=e(this).parents("row.master")[0];if(o=e(o).prev(),0!=o.children("panel[open]").next().length&&!et){var n=o.children("panel[open]"),a=n.next();a.show(),et=!0,t.html(r+=1),setTimeout(function(){n.removeAttr("open").attr("left",""),a.show().removeAttr("right").attr("open","")},0),setTimeout(function(){et=!1,n.hide()},700)}}),e(window).hammer(Ft).on("tap","a.button#btnbackwards",function(){var t=e(this).next("indicator"),r=parseInt(t.html()),o=e(this).parents("row.master")[0];if(o=e(o).prev(),0!=o.children("panel[open]").prev().length&&!et){var n=o.children("panel[open]"),a=n.prev();a.show(),et=!0,t.html(r-=1),setTimeout(function(){n.removeAttr("open").attr("right",""),a.removeAttr("left").attr("open","")},0),setTimeout(function(){et=!1,n.hide()},700)}}),e(window,document).on("submit",function(e){return e.preventDefault(),!1}),e(window).hammer(Ft).on("touch","input",function(e){e.preventDefault()}),e(".autoComplete").tinyAutocomplete({data:z,onSelect:function(t,r){null==r?e(".autoCompleteResults").html('All results for "'+e(this).val()+'" would go here'):(e(this).val(r.Name),console.log(e(this).val(r.Name)),e(".autoCompleteResults").html("<h1>"+r.Name+"</h1>"))}})}catch(Pt){alert(Pt.toString()),console.log(Pt.toString())}});