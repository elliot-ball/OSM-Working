!function(t,e){var s=function(t,s){var i=this;this.field=e(t),i.el=null,i.json=null,i.items=[],i.selectedItem=null,i.list=e('<ul class="autocomplete-list" />'),i.lastSearch=null,i.searchTimeout=null,i.searchTimeLimit=null,i.options=s};s.prototype={defaults:{minChars:2,markAsBold:!0,grouped:!1,queryProperty:"q",queryParameters:{},method:"get",scrollOnFocus:"auto",maxItems:100,timeLimit:null,keyboardDelay:200,lastItemTemplate:null,groupContentName:".autocomplete-items",groupTemplate:'<li class="autocomplete-group"><span class="autocomplete-group-header">{{Name}}</span><ul class="autocomplete-items" /></li>',itemTemplate:'<row groupid="{{ID_Group}}" fullpath="{{FullPath}}" grouppath="{{GroupPath}}"><a class="isselected" href="#">{{Name}}</a></row>'},init:function(){return this.settings=e.extend({},this.defaults,this.options),this.setupSettings(),this.setupMarkup(),this.setupEvents(),this},template:function(t,e){return t.replace(/{{\s*[\w]+\s*}}/g,function(t){return e[t.substr(2,t.length-4)]})},setupSettings:function(){"auto"==this.settings.scrollOnFocus&&(this.settings.scrollOnFocus=this.isTouchDevice()),e(t).height()<500&&(this.settings.maxItems=Math.min(this.settings.maxItems,3)),this.request=this.settings.data?this.localRequest:this.remoteRequest},setupEvents:function(){this.el.on("keyup",".autocomplete-field",e.proxy(this.onKeyUp,this)),this.el.on("keydown",".autocomplete-field",e.proxy(this.onKeyDown,this)),this.el.on("click",".autocomplete-item",e.proxy(this.onClickItem,this)),this.settings.scrollOnFocus&&this.field.on("focus",function(){var s=e(this).offset().top;setTimeout(function(){t.scrollTo(0,s)},0)})},setupMarkup:function(){this.field.addClass("autocomplete-field"),this.field.wrap('<div class="autocomplete" />'),this.el=this.field.parent()},limitedRequest:function(t){if((new Date).getTime()>this.searchTimeLimit)this.request(t);else{var e=this;clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(function(){e.request(t)},this.searchTimeLimit-(new Date).getTime())}},remoteRequest:function(t){var s={};e.extend(s,this.settings.queryParameters),s[this.settings.queryProperty]=t,e.ajax({method:this.settings.method,url:this.settings.url,dataType:"json",data:s,success:e.proxy(this.onReceiveData,this)}),this.settings.timeLimit&&(this.searchTimeLimit=(new Date).getTime()+this.settings.timeLimit)},localRequest:function(t){this.settings.grouped?this.onReceiveData(this.matchLocalPatternGrouped(t)):this.onReceiveData(this.matchLocalPatternFlat(t))},matchLocalPatternFlat:function(t){return this.matchArray(t,this.settings.data)},matchLocalPatternGrouped:function(t){for(var s=e.extend(!0,[],this.settings.data),i=0;i<s.length;i++){var n=this.matchArray(t,s[i].data);0==n.length?(s.splice(i,1),i--):s[i].data=n}return s},matchArray:function(t,e){for(var s=[],i=0;i<e.length;i++)for(var n in e[i])if(null!=e[i][n]&&(e[i][n].toLowerCase&&e[i][n].toLowerCase().indexOf(t.toLowerCase())>-1||e[i][n]==t)){s.push(e[i]);break}return s},itemAt:function(t){return null==t?e():e(".autocomplete-item").eq(t)},clickedItemAt:function(t){for(var e=0;e<this.items.length;e++)if(t==this.el.find(".autocomplete-item").eq(e).get(0))return e;return null},prevItem:function(){this.selectedItem--,this.selectedItem<0&&(this.selectedItem=null),this.markSelected(this.selectedItem)},nextItem:function(){null==this.selectedItem&&(this.selectedItem=-1),this.selectedItem++;var t=this.settings.lastItemTemplate?this.items.length:this.items.length-1;this.selectedItem>=t&&(this.selectedItem=t),this.markSelected(this.selectedItem)},markSelected:function(t){this.el.find(".active").removeClass("active"),this.itemAt(t).addClass("active")},markHitText:function(t,e){var s=e.split(" ");for(var i in t)if("string"==typeof t[i]&&"template"!=i)for(var n=0;n<s.length;n++){var l=s[n].trim().replace(/[^a-z0-9]/gi,"");l.length>0&&(t[i]=t[i].replace(new RegExp("("+l+")","gi"),"<strong>$1</strong>"))}return t},renderGroups:function(){this.list.remove(),this.list=e('<ul class="autocomplete-list" />');for(var t in this.json)this.list.append(this.template(this.settings.groupTemplate,this.json[t]));this.el.append(this.list)},renderItemsInGroups:function(){for(var t=this.field.val(),s=0;s<this.json.length;s++)for(var i=this.el.find(this.settings.groupContentName).eq(s),n=0;n<this.json[s].data.length&&n<this.settings.maxItems;n++){var l=e.extend({},this.json[s].data[n]);this.settings.markAsBold&&(l=this.markHitText(l,t)),i.append(this.template(this.json[s].template||this.settings.itemTemplate,l))}},renderItemsFlat:function(){this.list.remove(),this.list=e('<ul class="autocomplete-list" />');for(var t=this.field.val(),s=0;s<this.json.length&&s<this.settings.maxItems;s++){var i=e.extend({},this.json[s]);this.settings.markAsBold&&(i=this.markHitText(i,t)),this.list.append(this.template(this.json[s].template||this.settings.itemTemplate,i))}this.el.append(this.list)},renderLastItem:function(){this.list.append(this.template(this.settings.lastItemTemplate,{Name:this.field.val()}))},closeList:function(){e(".main").off("click"),this.list.remove(),this.selectedItem=null},getItemsFromGroups:function(){var t=[];for(var e in this.json)for(var s=0;s<this.json[e].data.length;s++)s<this.settings.maxItems&&t.push(this.json[e].data[s]);return t},valueHasChanged:function(){return this.field.val()!=this.lastSearch?(this.lastSearch=this.field.val(),!0):!1},isTouchDevice:function(){return!!("ontouchstart"in t)},onReceiveData:function(t){this.selectedItem=null,this.json=t,this.settings.grouped?(this.renderGroups(),this.items=this.getItemsFromGroups(),this.renderItemsInGroups()):(this.items=this.json,this.renderItemsFlat()),this.settings.lastItemTemplate&&this.renderLastItem(),e(".main").one("click",e.proxy(this.closeList,this))},onKeyUp:function(){if(this.settings.keyboardDelay){var t=this;clearTimeout(this.keyboardTimeout),this.keyboardTimeout=setTimeout(function(){t.checkFieldValue()},this.settings.keyboardDelay)}else this.checkFieldValue()},checkFieldValue:function(){this.field.val().length>=this.settings.minChars&&this.valueHasChanged()&&this.limitedRequest(this.field.val()),""==this.field.val()&&this.closeList()},onKeyDown:function(t){38==t.keyCode&&(t.preventDefault(),this.prevItem()),40==t.keyCode&&(t.preventDefault(),this.nextItem()),13==t.keyCode&&(t.preventDefault(),this.onPressEnter()),27==t.keyCode&&(t.preventDefault(),this.closeList())},onClickItem:function(t){var e=this.clickedItemAt(t.currentTarget);this.onSelect(t.currentTarget,this.items[e])},onPressEnter:function(){this.onSelect(this.itemAt(this.selectedItem),this.items[this.selectedItem])},onSelect:function(t,e){this.settings.onSelect&&this.settings.onSelect.apply(this.field,[t,e]),this.lastSearch=this.field.val(),this.closeList()}},s.defaults=s.prototype.defaults,e.fn.tinyAutocomplete=function(t){return this.each(function(){if(this.tinyAutocomplete)return e.extend(this.tinyAutocomplete.settings,t),this;var i=new s(this,t).init();this.tinyAutocomplete={settings:i.settings}})},e.tinyAutocomplete=s}(window,$);